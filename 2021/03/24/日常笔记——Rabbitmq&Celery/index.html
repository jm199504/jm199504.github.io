<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>æ—¥å¸¸ç¬”è®°â€”â€”Rabbitmq &amp; Celery | Jimmy&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="æ¦‚è¿°ï¼šæ—¥å¸¸ç¬”è®°â€”â€”Rabbitmq &amp; Celery">
<meta property="og:type" content="article">
<meta property="og:title" content="æ—¥å¸¸ç¬”è®°â€”â€”Rabbitmq &amp; Celery">
<meta property="og:url" content="http://example.com/2021/03/24/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94Rabbitmq&Celery/index.html">
<meta property="og:site_name" content="Jimmy&#39;s blog">
<meta property="og:description" content="æ¦‚è¿°ï¼šæ—¥å¸¸ç¬”è®°â€”â€”Rabbitmq &amp; Celery">
<meta property="og:locale">
<meta property="og:image" content="https://support.smartbear.com/readyapi/docs/_images/testing/amqp-about.png">
<meta property="og:image" content="https://img-blog.csdn.net/20170512105615019">
<meta property="og:image" content="https://img-blog.csdn.net/20170512103945228">
<meta property="og:image" content="https://img-blog.csdn.net/20170512111129762">
<meta property="og:image" content="http://example.com/Users/junmingguo/Downloads/vosamo.github.io-master/img/celery.png">
<meta property="og:image" content="https://img-blog.csdn.net/20161213105123227">
<meta property="article:published_time" content="2021-03-24T09:09:39.082Z">
<meta property="article:modified_time" content="2021-04-02T06:44:38.585Z">
<meta property="article:author" content="Jimmy Guo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://support.smartbear.com/readyapi/docs/_images/testing/amqp-about.png">
  
    <link rel="alternate" href="/atom.xml" title="Jimmy's blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Jimmy&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-æ—¥å¸¸ç¬”è®°â€”â€”Rabbitmq&amp;Celery" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/24/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94Rabbitmq&Celery/" class="article-date">
  <time class="dt-published" datetime="2021-03-24T09:09:39.082Z" itemprop="datePublished">2021-03-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Notes/">Notes</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      æ—¥å¸¸ç¬”è®°â€”â€”Rabbitmq &amp; Celery
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>æ¦‚è¿°ï¼šæ—¥å¸¸ç¬”è®°â€”â€”Rabbitmq &amp; Celery</p>
<span id="more"></span>

<h1 id="Rabbitmq-amp-Celery"><a href="#Rabbitmq-amp-Celery" class="headerlink" title="Rabbitmq &amp; Celery"></a>Rabbitmq &amp; Celery</h1><h1 id="ä¸€ã€Rabbitmq"><a href="#ä¸€ã€Rabbitmq" class="headerlink" title="ä¸€ã€Rabbitmq"></a>ä¸€ã€Rabbitmq</h1><h2 id="1-å®‰è£…"><a href="#1-å®‰è£…" class="headerlink" title="1.å®‰è£…"></a>1.å®‰è£…</h2><p>ä»¥<code>mac OS</code>ä¸ºä¾‹ï¼š</p>
<p>ï¼ˆ1ï¼‰å®‰è£…Homebrew [å·²å®‰è£…å¯å¿½ç•¥]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby -e &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;Homebrew&#x2F;install&#x2F;master&#x2F;install)&quot;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰é€šè¿‡<code>brew</code>å®‰è£…Rabbitmq</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install rabbitmq</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰ç¯å¢ƒå˜é‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;profile</span><br><span class="line">PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;sbin</span><br></pre></td></tr></table></figure>

<h2 id="2-åŸºç¡€æ¦‚å¿µ"><a href="#2-åŸºç¡€æ¦‚å¿µ" class="headerlink" title="2.åŸºç¡€æ¦‚å¿µ"></a>2.åŸºç¡€æ¦‚å¿µ</h2><p>ï¼ˆ1ï¼‰é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAdvanced Message Queueing Protocol, AMQPï¼‰æ˜¯é¢å‘æ¶ˆæ¯ä¸­é—´ä»¶çš„å¼€æ”¾æ ‡å‡†åº”ç”¨ç¨‹åºå±‚åè®®ã€‚</p>
<p>ï¼ˆ2ï¼‰åœ¨AMQPä¸­ï¼Œå‘é€æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºï¼ˆç§°ä¸ºç”Ÿäº§è€…ï¼‰å°†æ¶ˆæ¯å‘å¸ƒåˆ°AMQPä»£ç†ï¼Œè¯¥ä»£ç†å°†æ¶ˆæ¯åˆ†å‘ç»™å¤„ç†æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºï¼ˆæ¶ˆè´¹è€…ï¼‰ã€‚</p>
<p>ï¼ˆ3ï¼‰AMQP æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ï¼ˆBrokerï¼‰çš„å†…éƒ¨ç»“æ„ä¸»è¦åŒ…æ‹¬ä¸‰ç§å®ä½“ï¼Œåˆ†åˆ«æ˜¯äº¤æ¢å™¨ï¼ˆExchangeï¼‰ã€é˜Ÿåˆ—ï¼ˆQueueï¼‰ã€ç»‘å®šï¼ˆbindingsï¼‰ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://support.smartbear.com/readyapi/docs/_images/testing/amqp-about.png" alt="img"></p>
<p>å…¶ä¸­bingingsæ˜¯æŒ‡å°†Exchangeå’ŒQueueæŒ‰è·¯ç”±è§„åˆ™ç»‘å®šã€‚</p>
<p>ï¼ˆ4ï¼‰Exchangeåˆ†å‘æ¶ˆæ¯æ—¶æ ¹æ®ç±»å‹çš„ä¸åŒåˆ†å‘ç­–ç•¥æœ‰åŒºåˆ«ï¼Œç›®å‰å…±ä¸‰ç§ç±»å‹ï¼šdirectã€fanoutã€topicã€‚</p>
<ul>
<li><code>direct</code></li>
</ul>
<p><img src="https://img-blog.csdn.net/20170512105615019" alt="img"></p>
<p>æ¶ˆæ¯ä¸­çš„è·¯ç”±é”®ï¼ˆrouting keyï¼‰å¦‚æœå’Œ Binding ä¸­çš„ binding key ä¸€è‡´ï¼Œ äº¤æ¢å™¨å°±å°†æ¶ˆæ¯å‘åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸­ã€‚è·¯ç”±é”®ä¸é˜Ÿåˆ—åå®Œå…¨åŒ¹é…ï¼Œå¦‚æœä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºè¦æ±‚è·¯ç”±é”®ä¸ºâ€œdogâ€ï¼Œåˆ™åªè½¬å‘ routing key æ ‡è®°ä¸ºâ€œdogâ€çš„æ¶ˆæ¯ï¼Œä¸ä¼šè½¬å‘â€œdog.puppyâ€ï¼Œä¹Ÿä¸ä¼šè½¬å‘â€œdog.guardâ€ç­‰ç­‰ã€‚å®ƒæ˜¯å®Œå…¨åŒ¹é…ã€å•æ’­çš„æ¨¡å¼ã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼šç°åœ¨æˆ‘ä»¬è€ƒè™‘åªæŠŠé‡è¦çš„æ—¥å¿—æ¶ˆæ¯å†™å…¥ç£ç›˜æ–‡ä»¶ï¼Œä¾‹å¦‚åªæŠŠ Error çº§åˆ«çš„æ—¥å¿—å‘é€ç»™è´Ÿè´£è®°å½•å†™å…¥ç£ç›˜æ–‡ä»¶çš„ Queueã€‚è¿™ç§åœºæ™¯ä¸‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„ RoutingKeyï¼ˆä¾‹å¦‚ errorï¼‰å°†å†™å…¥ç£ç›˜æ–‡ä»¶çš„ Queue ç»‘å®šåˆ° Direct Exchange ä¸Šã€‚</p>
<ul>
<li><code>fanout</code></li>
</ul>
<p><img src="https://img-blog.csdn.net/20170512103945228" alt="img"></p>
<p>æ¯ä¸ªå‘åˆ° fanout ç±»å‹äº¤æ¢å™¨çš„æ¶ˆæ¯éƒ½ä¼šåˆ†åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ä¸Šå»ã€‚fanout äº¤æ¢å™¨ä¸å¤„ç†è·¯ç”±é”®ï¼ˆæ²¡æœ‰è·¯ç”±é”®æ¦‚å¿µï¼‰ï¼Œåªæ˜¯ç®€å•çš„å°†é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢å™¨ä¸Šï¼Œæ¯ä¸ªå‘é€åˆ°äº¤æ¢å™¨çš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°ä¸è¯¥äº¤æ¢å™¨ç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ä¸Šã€‚å¾ˆåƒå­ç½‘å¹¿æ’­ï¼Œæ¯å°å­ç½‘å†…çš„ä¸»æœºéƒ½è·å¾—äº†ä¸€ä»½å¤åˆ¶çš„æ¶ˆæ¯ã€‚fanout ç±»å‹è½¬å‘æ¶ˆæ¯æ˜¯æœ€å¿«çš„ï¼Œä¹Ÿå®ç°äº†ä¸€ä¸ªæ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…è·å–çš„éœ€æ±‚ã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼šä»¥æ—¥å¿—ç³»ç»Ÿä¸ºä¾‹ï¼šå‡è®¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª Exchange æ¥æ¥æ”¶æ—¥å¿—æ¶ˆæ¯ï¼ŒåŒæ—¶å®šä¹‰äº†ä¸¤ä¸ª Queue æ¥å­˜å‚¨æ¶ˆæ¯ï¼šä¸€ä¸ªè®°å½•å°†è¢«æ‰“å°åˆ°æ§åˆ¶å°çš„æ—¥å¿—æ¶ˆæ¯ï¼›å¦ä¸€ä¸ªè®°å½•å°†è¢«å†™å…¥ç£ç›˜æ–‡ä»¶çš„æ—¥å¿—æ¶ˆæ¯ã€‚æˆ‘ä»¬å¸Œæœ› Exchange æ¥æ”¶åˆ°çš„æ¯ä¸€æ¡æ¶ˆæ¯éƒ½ä¼šåŒæ—¶è¢«è½¬å‘åˆ°ä¸¤ä¸ª Queueï¼Œè¿™ç§åœºæ™¯ä¸‹å°±å¯ä»¥ä½¿ç”¨ Fanout Exchange æ¥å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰ç»‘å®šçš„ Queueã€‚</p>
<ul>
<li><code>topic</code></li>
</ul>
<p><img src="https://img-blog.csdn.net/20170512111129762" alt="img"></p>
<p>topic äº¤æ¢å™¨é€šè¿‡æ¨¡å¼åŒ¹é…åˆ†é…æ¶ˆæ¯çš„è·¯ç”±é”®å±æ€§ï¼Œå°†è·¯ç”±é”®å’ŒæŸä¸ªæ¨¡å¼è¿›è¡ŒåŒ¹é…ï¼Œæ­¤æ—¶é˜Ÿåˆ—éœ€è¦ç»‘å®šåˆ°ä¸€ä¸ªæ¨¡å¼ä¸Šã€‚å®ƒå°†è·¯ç”±é”®å’Œç»‘å®šé”®çš„å­—ç¬¦ä¸²åˆ‡åˆ†æˆå•è¯ï¼Œè¿™äº›å•è¯ä¹‹é—´ç”¨ç‚¹éš”å¼€ã€‚å®ƒåŒæ ·ä¹Ÿä¼šè¯†åˆ«ä¸¤ä¸ªé€šé…ç¬¦ï¼šç¬¦å·â€œ#â€å’Œç¬¦å·â€œâ€ã€‚#åŒ¹é…0ä¸ªæˆ–å¤šä¸ªå•è¯<em>ï¼Œ</em>åŒ¹é…ä¸å¤šä¸å°‘ä¸€ä¸ªå•è¯ã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼šå‡è®¾æˆ‘ä»¬çš„æ¶ˆæ¯è·¯ç”±è§„åˆ™é™¤äº†éœ€è¦æ ¹æ®æ—¥å¿—çº§åˆ«æ¥åˆ†å‘ä¹‹å¤–è¿˜éœ€è¦æ ¹æ®æ¶ˆæ¯æ¥æºåˆ†å‘ï¼Œå¯ä»¥å°† RoutingKey å®šä¹‰ä¸º <code>æ¶ˆæ¯æ¥æº.çº§åˆ«</code> å¦‚ <code>order.info</code>ã€<code>user.error</code>ç­‰ã€‚å¤„ç†æ‰€æœ‰æ¥æºä¸º <code>user</code> çš„ Queue å°±å¯ä»¥é€šè¿‡ <code>user.*</code> ç»‘å®šåˆ° Topic Exchange ä¸Šï¼Œè€Œå¤„ç†æ‰€æœ‰æ—¥å¿—çº§åˆ«ä¸º <code>info</code> çš„ Queue å¯ä»¥é€šè¿‡ <code>*.info</code> ç»‘å®šåˆ° Exchangeä¸Šã€‚</p>
<h2 id="3-å¸¸è§å‘½ä»¤"><a href="#3-å¸¸è§å‘½ä»¤" class="headerlink" title="3.å¸¸è§å‘½ä»¤"></a>3.å¸¸è§å‘½ä»¤</h2><h3 id="ï¼ˆ1ï¼‰å¯åŠ¨æœåŠ¡"><a href="#ï¼ˆ1ï¼‰å¯åŠ¨æœåŠ¡" class="headerlink" title="ï¼ˆ1ï¼‰å¯åŠ¨æœåŠ¡"></a>ï¼ˆ1ï¼‰å¯åŠ¨æœåŠ¡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server</span><br><span class="line">&#x2F;&#x2F; å¤‡æ³¨ï¼šå¯åŠ¨å¤±è´¥å¯å°è¯• sudo rabbitmq-server</span><br><span class="line">&#x2F;&#x2F; åå°å¯åŠ¨ï¼šrabbitmq-server -detached  </span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ2ï¼‰æŸ¥çœ‹çŠ¶æ€"><a href="#ï¼ˆ2ï¼‰æŸ¥çœ‹çŠ¶æ€" class="headerlink" title="ï¼ˆ2ï¼‰æŸ¥çœ‹çŠ¶æ€"></a>ï¼ˆ2ï¼‰æŸ¥çœ‹çŠ¶æ€</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl status</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ3ï¼‰è®¿é—®"><a href="#ï¼ˆ3ï¼‰è®¿é—®" class="headerlink" title="ï¼ˆ3ï¼‰è®¿é—®"></a>ï¼ˆ3ï¼‰è®¿é—®</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:15672</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é»˜è®¤è´¦å·åŠå¯†ç å‡ä¸ºguest</span> </span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ4ï¼‰åœæ­¢æœåŠ¡"><a href="#ï¼ˆ4ï¼‰åœæ­¢æœåŠ¡" class="headerlink" title="ï¼ˆ4ï¼‰åœæ­¢æœåŠ¡"></a>ï¼ˆ4ï¼‰åœæ­¢æœåŠ¡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-service stop</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ5ï¼‰æŸ¥çœ‹æ‰€æœ‰é˜Ÿåˆ—"><a href="#ï¼ˆ5ï¼‰æŸ¥çœ‹æ‰€æœ‰é˜Ÿåˆ—" class="headerlink" title="ï¼ˆ5ï¼‰æŸ¥çœ‹æ‰€æœ‰é˜Ÿåˆ—"></a>ï¼ˆ5ï¼‰æŸ¥çœ‹æ‰€æœ‰é˜Ÿåˆ—</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl list_queues</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ6ï¼‰æ¸…é™¤æ‰€æœ‰çš„é˜Ÿåˆ—"><a href="#ï¼ˆ6ï¼‰æ¸…é™¤æ‰€æœ‰çš„é˜Ÿåˆ—" class="headerlink" title="ï¼ˆ6ï¼‰æ¸…é™¤æ‰€æœ‰çš„é˜Ÿåˆ—"></a>ï¼ˆ6ï¼‰æ¸…é™¤æ‰€æœ‰çš„é˜Ÿåˆ—</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl reset</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ7ï¼‰æ·»åŠ ç”¨æˆ·"><a href="#ï¼ˆ7ï¼‰æ·»åŠ ç”¨æˆ·" class="headerlink" title="ï¼ˆ7ï¼‰æ·»åŠ ç”¨æˆ·"></a>ï¼ˆ7ï¼‰æ·»åŠ ç”¨æˆ·</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user username password</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ8ï¼‰åˆ†é…è§’è‰²"><a href="#ï¼ˆ8ï¼‰åˆ†é…è§’è‰²" class="headerlink" title="ï¼ˆ8ï¼‰åˆ†é…è§’è‰²"></a>ï¼ˆ8ï¼‰åˆ†é…è§’è‰²</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_user_tags username administrator</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ9ï¼‰æ–°å¢è™šæ‹Ÿä¸»æœº"><a href="#ï¼ˆ9ï¼‰æ–°å¢è™šæ‹Ÿä¸»æœº" class="headerlink" title="ï¼ˆ9ï¼‰æ–°å¢è™šæ‹Ÿä¸»æœº"></a>ï¼ˆ9ï¼‰æ–°å¢è™šæ‹Ÿä¸»æœº</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_vhost vhost_name</span><br></pre></td></tr></table></figure>



<h2 id="4-Hello-Rabbitmq"><a href="#4-Hello-Rabbitmq" class="headerlink" title="4.Hello Rabbitmq"></a>4.Hello Rabbitmq</h2><p>Hello Worldå°†å±•ç¤ºç”Ÿäº§è€…ä¼ è¾“æ•°æ®è‡³æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–æ•°æ®çš„è¿‡ç¨‹ï¼Œç±»ä¼¼äºä¸‹å›¾ï¼š</p>
<p>![image-20201017214611765](/Users/junmingguo/Library/Application Support/typora-user-images/image-20201017214611765.png)</p>
<p>å…¶ä¸­Pè¡¨ç¤ºç”Ÿäº§è€…ï¼ŒCè¡¨ç¤ºæ¶ˆè´¹è€…ï¼Œçº¢è‰²çŸ©é˜µè¡¨ç¤ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œhelloè¡¨ç¤ºä¼ è¾“çš„æ•°æ®ã€‚</p>
<h3 id="ï¼ˆ1ï¼‰ç”Ÿäº§è€…"><a href="#ï¼ˆ1ï¼‰ç”Ÿäº§è€…" class="headerlink" title="ï¼ˆ1ï¼‰ç”Ÿäº§è€…"></a>ï¼ˆ1ï¼‰ç”Ÿäº§è€…</h3><p><code>send.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">queue = <span class="string">&#x27;demo_queue&#x27;</span>  <span class="comment"># é˜Ÿåˆ—åç§°</span></span><br><span class="line">routing_key = <span class="string">&#x27;url_test&#x27;</span>  <span class="comment"># è·¯ç”±é”®</span></span><br><span class="line">exchange = <span class="string">&#x27;oss_test&#x27;</span>  <span class="comment"># äº¤æ¢å™¨åç§°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–°å»ºè¿æ¥ï¼Œrabbitmqå®‰è£…åœ¨æœ¬åœ°åˆ™hostnameä¸º&#x27;localhost&#x27;</span></span><br><span class="line">hostname = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="number">5672</span></span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(username=<span class="string">&#x27;guest&#x27;</span>, password=<span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">parameters = pika.ConnectionParameters(host=hostname, port=port, credentials=credentials)</span><br><span class="line">connection = pika.BlockingConnection(parameters=parameters)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé€šé“</span></span><br><span class="line">channel = connection.channel()</span><br><span class="line"><span class="comment"># åˆ›å»ºbroker: äº¤æ¢å™¨ç±»å‹ä¸ºdirectï¼Œdurableå±æ€§ä¸ºtrueæ—¶è¡¨ç¤ºä¼šåˆ›å»ºä¸€ä¸ªæŒä¹…åŒ–çš„äº¤æ¢å™¨</span></span><br><span class="line">channel.exchange_declare(exchange=exchange, exchange_type=<span class="string">&#x27;direct&#x27;</span>, durable=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½è¦å£°æ˜ä¸€ä¸ªç›¸åŒçš„é˜Ÿåˆ—ï¼Œç”¨æ¥é˜²æ­¢ä¸‡ä¸€æŸä¸€æ–¹æŒ‚äº†ï¼Œå¦ä¸€æ–¹èƒ½æ­£å¸¸è¿è¡Œ</span></span><br><span class="line">channel.queue_declare(queue=queue, durable=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># æŠŠé˜Ÿåˆ—å’Œä¸­é—´äººç»‘å®š</span></span><br><span class="line">channel.queue_bind(exchange=exchange, queue=queue, routing_key=routing_key)</span><br><span class="line"><span class="comment"># äº¤æ¢æœº; é˜Ÿåˆ—å,å†™æ˜å°†æ¶ˆæ¯å‘å¾€å“ªä¸ªé˜Ÿåˆ—; æ¶ˆæ¯å†…å®¹</span></span><br><span class="line"><span class="comment"># routing_keyåœ¨ä½¿ç”¨åŒ¿åäº¤æ¢æœºçš„æ—¶å€™æ‰éœ€è¦æŒ‡å®šï¼Œè¡¨ç¤ºå‘é€åˆ°å“ªä¸ªé˜Ÿåˆ—,æ³¨æ„å½“æœªå®šä¹‰exchangeæ—¶ï¼Œrouting_keyéœ€å’Œqueueçš„å€¼ä¿æŒä¸€è‡´</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;jimmy&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">channel.basic_publish(exchange=exchange, routing_key=routing_key, body=json.dumps(data))</span><br><span class="line"><span class="comment"># å…³é—­è¿æ¥</span></span><br><span class="line">connection.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ2ï¼‰æ¶ˆè´¹è€…"><a href="#ï¼ˆ2ï¼‰æ¶ˆè´¹è€…" class="headerlink" title="ï¼ˆ2ï¼‰æ¶ˆè´¹è€…"></a>ï¼ˆ2ï¼‰æ¶ˆè´¹è€…</h3><p><code>receive.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"></span><br><span class="line">queue = <span class="string">&#x27;demo_queue&#x27;</span>  <span class="comment"># é˜Ÿåˆ—å</span></span><br><span class="line"></span><br><span class="line">hostname = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="number">5672</span></span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(username=<span class="string">&#x27;guest&#x27;</span>, password=<span class="string">&#x27;guest&#x27;</span>)</span><br><span class="line">parameters = pika.ConnectionParameters(host=hostname, port=port, credentials=credentials)</span><br><span class="line">connection = pika.BlockingConnection(parameters=parameters)</span><br><span class="line"><span class="comment"># åˆ›å»ºé€šé“</span></span><br><span class="line">channel = connection.channel()</span><br><span class="line">channel.queue_declare(queue=queue, durable=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">ch, method, properties, body</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ¥æ”¶åˆ°çš„æ¶ˆæ¯ ======&gt; <span class="subst">&#123;body&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># ch.basic_ack(delivery_tag=method.delivery_tag)  # å‘é€ackæ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ä¸æŒ‰é¡ºåºåˆ†é…æ¶ˆæ¯çš„å‚æ•°ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line"><span class="comment"># channel.basic_qos(prefetch_count=1)</span></span><br><span class="line"><span class="comment"># rabbitmqä½¿ç”¨callbackæ¥æ¥æ”¶ä¿¡æ¯</span></span><br><span class="line">channel.basic_consume(queue=queue,</span><br><span class="line">                      on_message_callback=callback,</span><br><span class="line">                      auto_ack=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å§‹æ¥æ”¶ä¿¡æ¯ï¼Œå¹¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œé˜Ÿåˆ—é‡Œæœ‰ä¿¡æ¯æ‰ä¼šè°ƒç”¨callbackè¿›è¡Œå¤„ç†,æŒ‰ctrl+cé€€å‡º</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ­£åœ¨ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ï¼Œé€€å‡ºè¯·æŒ‰CTRL+C â€¦â€¦&#x27;</span>)</span><br><span class="line">channel.start_consuming()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>æ‰§è¡Œ<code>receive.py</code></li>
<li>æ‰§è¡Œ2æ¬¡<code>send.py</code>åï¼ŒæŸ¥çœ‹é˜Ÿåˆ—ï¼Œä¼šå‘ç°Ready=2ï¼š</li>
</ul>
<p>![image-20201017213921348](/Users/junmingguo/Library/Application Support/typora-user-images/image-20201017213921348.png)</p>
<ul>
<li>æŸ¥çœ‹æ¶ˆè´¹è€…çš„ç»ˆç«¯è¾“å‡º </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ­£åœ¨ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ï¼Œé€€å‡ºè¯·æŒ‰CTRL+C â€¦â€¦</span><br><span class="line">æ¥æ”¶åˆ°çš„æ¶ˆæ¯ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; b&#39;&#123;&quot;name&quot;: &quot;jimmy&quot;&#125;&#39;</span><br><span class="line">æ¥æ”¶åˆ°çš„æ¶ˆæ¯ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; b&#39;&#123;&quot;name&quot;: &quot;jimmy&quot;&#125;&#39;</span><br></pre></td></tr></table></figure>



<h2 id="5-é—®é¢˜è®°å½•"><a href="#5-é—®é¢˜è®°å½•" class="headerlink" title="5.é—®é¢˜è®°å½•"></a>5.é—®é¢˜è®°å½•</h2><h3 id="ï¼ˆ1ï¼‰æ¶ˆè´¹è€…æ¥æ”¶å¼‚å¸¸"><a href="#ï¼ˆ1ï¼‰æ¶ˆè´¹è€…æ¥æ”¶å¼‚å¸¸" class="headerlink" title="ï¼ˆ1ï¼‰æ¶ˆè´¹è€…æ¥æ”¶å¼‚å¸¸"></a>ï¼ˆ1ï¼‰æ¶ˆè´¹è€…æ¥æ”¶å¼‚å¸¸</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">channel.basic_consume(callback, queue=queue, no_ack=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># TypeError: basic_consume() got multiple values for argument &#x27;queue&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ç‰ˆæœ¬æ›´æ–°å¯¼è‡´å‚æ•°ä½ç½®å’Œå‚æ•°åç§°å‡æ¶‰åŠæ›´æ–°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basic_consume(queue=queue, on_message_callback=callback,auto_ack=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ2ï¼‰å¯åŠ¨è¿‡ç¨‹å¼‚å¸¸"><a href="#ï¼ˆ2ï¼‰å¯åŠ¨è¿‡ç¨‹å¼‚å¸¸" class="headerlink" title="ï¼ˆ2ï¼‰å¯åŠ¨è¿‡ç¨‹å¼‚å¸¸"></a>ï¼ˆ2ï¼‰å¯åŠ¨è¿‡ç¨‹å¼‚å¸¸</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zsh: command not found: rabbitmq-server</span><br></pre></td></tr></table></figure>

<p>ç¼–è¾‘<code>~/.zshrc</code>å¹¶å†™å…¥ä»¥ä¸‹3è¡Œé…ç½®</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.zshrc</span><br><span class="line"></span><br><span class="line">PATH=$PATH:/usr/local/sbin</span><br><span class="line">export PATH=$PATH:/usr/local/sbin</span><br><span class="line">export PATH=/usr/local/sbin:$PATH</span><br><span class="line"></span><br><span class="line">source .zshrc</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰“å¼€æ–°çª—å£</span></span><br><span class="line"></span><br><span class="line">rabbitmq-server</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰å¯åŠ¨è¿‡ç¨‹å¼‚å¸¸</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Configuring logger redirection</span><br><span class="line"><span class="number">10</span>:<span class="number">03</span>:<span class="number">26</span>.<span class="number">920</span> [warning] Failed to write PID file &quot;/usr/local/var/lib/rabbitmq/mnesia/rabbit@localhost.pid&quot;: permission denied</span><br><span class="line"><span class="number">10</span>:<span class="number">03</span>:<span class="number">27</span>.<span class="number">093</span> [error] Supervisor ra_system_sup had child ra_log_ets started with ra_log_ets:start_link......</span><br><span class="line">Kernel pid terminated (application_controller) (&#123;application_start_failure,ra,&#123;&#123;shutdown,&#123;failed_to_start_child,ra_system_sup,&#123;shutdown,&#123;failed_to_start_child,ra_log_ets,&#123;&#123;badmatch,&#123;error,&#123;file_error,</span><br><span class="line"></span><br><span class="line">Crash dump is being written to: erl_crash.dump...done</span><br></pre></td></tr></table></figure>

<p>è§£å†³: <code>sudo rabbitmq-server</code></p>
<h3 id="ï¼ˆ3ï¼‰å¯åŠ¨å¤±è´¥"><a href="#ï¼ˆ3ï¼‰å¯åŠ¨å¤±è´¥" class="headerlink" title="ï¼ˆ3ï¼‰å¯åŠ¨å¤±è´¥"></a>ï¼ˆ3ï¼‰å¯åŠ¨å¤±è´¥</h3><p>zsh: command not found: rabbitmq-server</p>
<p>ç¼–è¾‘~/.zshrcå¹¶å†™å…¥ä»¥ä¸‹3è¡Œé…ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim ~&#x2F;.zshrc</span><br><span class="line"></span><br><span class="line">PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;sbin</span><br><span class="line">export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;sbin</span><br><span class="line">export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:$PATH</span><br><span class="line"></span><br><span class="line">source .zshrc</span><br><span class="line"></span><br><span class="line"># æ‰“å¼€æ–°çª—å£</span><br><span class="line"></span><br><span class="line">rabbitmq-server</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ4ï¼‰å®‰è£…ç›¸å…³å¼‚å¸¸"><a href="#ï¼ˆ4ï¼‰å®‰è£…ç›¸å…³å¼‚å¸¸" class="headerlink" title="ï¼ˆ4ï¼‰å®‰è£…ç›¸å…³å¼‚å¸¸"></a>ï¼ˆ4ï¼‰å®‰è£…ç›¸å…³å¼‚å¸¸</h3><p>ï¼ˆ1ï¼‰é—®é¢˜ï¼šæ‰§è¡Œ<code>sudo make test</code>ç¼–è¯‘è¿‡ç¨‹å¯èƒ½æŠ¥é”™</p>
<p>è§£å†³æ–¹æ¡ˆï¼šæ‰§è¡Œå‘½ä»¤æ¸…ç†å†ç¼–è¯‘ï¼š<code>sudo make distclean &amp;&amp; sudo make &amp;&amp; sudo make test</code></p>
<p>ï¼ˆ2ï¼‰é—®é¢˜ï¼šå®‰è£…Redisçš„ç¼–è¯‘è¿‡ç¨‹å‡ºç°é—®é¢˜<code>â€œFailed opening the RDB file dump.rdb (in server root dir /usr/local/redis-6.0.5) for saving: Permission deniedâ€</code>ï¼Œè¯´æ˜æœªèµ‹äºˆæƒé™ï¼Œéœ€è¦å¯¹æ‰€å®‰è£…çš„redisç›®å½•ç»™äºˆ777æƒé™ï¼š</p>
<p>è§£å†³æ–¹æ¡ˆï¼š<code>sudo chmod -R 0777 redis-6.0.5</code></p>
<h1 id="äºŒã€Celery"><a href="#äºŒã€Celery" class="headerlink" title="äºŒã€Celery"></a>äºŒã€Celery</h1><h2 id="1-æ¨¡å—æ¶æ„"><a href="#1-æ¨¡å—æ¶æ„" class="headerlink" title="1.æ¨¡å—æ¶æ„"></a>1.æ¨¡å—æ¶æ„</h2><p><img src="/Users/junmingguo/Downloads/vosamo.github.io-master/img/celery.png" alt="celery"></p>
<p><img src="https://img-blog.csdn.net/20161213105123227" alt="Celery_framework"></p>
<p>Celeryæ¨¡å—ï¼š</p>
<ul>
<li>ä»»åŠ¡æ¨¡å— Task</li>
</ul>
<p>åŒ…å«å¼‚æ­¥ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ã€‚å…¶ä¸­ï¼Œå¼‚æ­¥ä»»åŠ¡é€šå¸¸åœ¨ä¸šåŠ¡é€»è¾‘ä¸­è¢«è§¦å‘å¹¶å‘å¾€ä»»åŠ¡é˜Ÿåˆ—ï¼Œè€Œå®šæ—¶ä»»åŠ¡ç”± Celery Beat è¿›ç¨‹å‘¨æœŸæ€§åœ°å°†ä»»åŠ¡å‘å¾€ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<ul>
<li>æ¶ˆæ¯ä¸­é—´ä»¶ Broker</li>
</ul>
<p>Brokerï¼Œå³ä¸ºä»»åŠ¡è°ƒåº¦é˜Ÿåˆ—ï¼Œæ¥æ”¶ä»»åŠ¡ç”Ÿäº§è€…å‘æ¥çš„æ¶ˆæ¯ï¼ˆå³ä»»åŠ¡ï¼‰ï¼Œå°†ä»»åŠ¡å­˜å…¥é˜Ÿåˆ—ã€‚Celery æœ¬èº«ä¸æä¾›é˜Ÿåˆ—æœåŠ¡ï¼Œå®˜æ–¹æ¨èä½¿ç”¨ RabbitMQ å’Œ Redis ç­‰ã€‚</p>
<ul>
<li>ä»»åŠ¡æ‰§è¡Œå•å…ƒ Worker</li>
</ul>
<p>Worker æ˜¯æ‰§è¡Œä»»åŠ¡çš„å¤„ç†å•å…ƒï¼Œå®ƒå®æ—¶ç›‘æ§æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè·å–é˜Ÿåˆ—ä¸­è°ƒåº¦çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå®ƒã€‚</p>
<ul>
<li>ä»»åŠ¡ç»“æœå­˜å‚¨ Backend</li>
</ul>
<p>Backend ç”¨äºå­˜å‚¨ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œä»¥ä¾›æŸ¥è¯¢ã€‚åŒæ¶ˆæ¯ä¸­é—´ä»¶ä¸€æ ·ï¼Œå­˜å‚¨ä¹Ÿå¯ä½¿ç”¨ RabbitMQ, Redis å’Œ MongoDB ç­‰ã€‚</p>
<h2 id="2-åŸºæœ¬æ¦‚å¿µ"><a href="#2-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="2.åŸºæœ¬æ¦‚å¿µ"></a>2.åŸºæœ¬æ¦‚å¿µ</h2><p>ä»»åŠ¡ç”Ÿäº§è€… (task producer) è´Ÿè´£äº§ç”Ÿè®¡ç®—ä»»åŠ¡ï¼Œäº¤ç»™ä»»åŠ¡é˜Ÿåˆ—å»å¤„ç†ã€‚</p>
<p>ä»»åŠ¡è°ƒåº¦å™¨ (celery beat)ä¼šè¯»å–é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œå‘¨æœŸæ€§åœ°å°†æ‰§è¡Œä»»åŠ¡çš„è¯·æ±‚å‘é€ç»™ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<p>ä»»åŠ¡ä»£ç† (broker)è´Ÿè´£æ¥å—ä»»åŠ¡ç”Ÿäº§è€…å‘é€è¿‡æ¥çš„ä»»åŠ¡å¤„ç†æ¶ˆæ¯ï¼Œå­˜è¿›é˜Ÿåˆ—ä¹‹åå†è¿›è¡Œè°ƒåº¦ï¼Œåˆ†å‘ç»™ä»»åŠ¡æ¶ˆè´¹æ–¹ (celery worker)ã€‚</p>
<p>ä»»åŠ¡æ¶ˆè´¹æ–¹ (celery worker)è´Ÿè´£æ¥æ”¶ä»»åŠ¡å¤„ç†ä¸­é—´æ–¹å‘æ¥çš„ä»»åŠ¡å¤„ç†è¯·æ±‚ï¼Œå®Œæˆè¿™äº›ä»»åŠ¡ï¼Œå¹¶ä¸”è¿”å›ä»»åŠ¡å¤„ç†çš„ç»“æœã€‚</p>
<p>Result Backendï¼šä»»åŠ¡å¤„ç†å®Œåä¿å­˜çŠ¶æ€ä¿¡æ¯å’Œç»“æœï¼Œä»¥ä¾›æŸ¥è¯¢ã€‚Celeryé»˜è®¤å·²æ”¯æŒRedisã€RabbitMQã€MongoDBã€Django ORMã€SQLAlchemyç­‰æ–¹å¼ã€‚</p>
<h2 id="3-Hello-Celery"><a href="#3-Hello-Celery" class="headerlink" title="3.Hello Celery"></a>3.Hello Celery</h2><h3 id="ï¼ˆ1ï¼‰å®‰è£…"><a href="#ï¼ˆ1ï¼‰å®‰è£…" class="headerlink" title="ï¼ˆ1ï¼‰å®‰è£…"></a>ï¼ˆ1ï¼‰å®‰è£…</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install celery==<span class="number">4</span>.<span class="number">4</span>.<span class="number">7</span></span><br></pre></td></tr></table></figure>

<p>Tipï¼šcelery( v5.0.0 )å­˜åœ¨ç¼ºé™·â€”â€”backendæ‰¾ä¸åˆ°amqp</p>
<h3 id="ï¼ˆ2ï¼‰åˆ›å»ºceleryåº”ç”¨"><a href="#ï¼ˆ2ï¼‰åˆ›å»ºceleryåº”ç”¨" class="headerlink" title="ï¼ˆ2ï¼‰åˆ›å»ºceleryåº”ç”¨"></a>ï¼ˆ2ï¼‰åˆ›å»ºceleryåº”ç”¨</h3><p><code>tasks.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">&#x27;task_name&#x27;</span>, broker=<span class="string">&#x27;amqp://guest:guest@127.0.0.1:5672&#x27;</span>)  <span class="comment"># ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå½“å‰æ¨¡å—åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸­é—´ä»¶å‚æ•°â€”â€”æŒ‡å®šä½ ä½¿ç”¨çš„æ¶ˆæ¯ä¸­é—´ä»¶URL</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ3ï¼‰å¯åŠ¨worker"><a href="#ï¼ˆ3ï¼‰å¯åŠ¨worker" class="headerlink" title="ï¼ˆ3ï¼‰å¯åŠ¨worker"></a>ï¼ˆ3ï¼‰å¯åŠ¨worker</h3><p>ğŸ—’ï¼š<code>tasks</code>ä¸ºå·¥ç¨‹å</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery -A tasks worker --loglevel=INFO [-Q QUEUE_NAME]</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ4ï¼‰è°ƒç”¨application"><a href="#ï¼ˆ4ï¼‰è°ƒç”¨application" class="headerlink" title="ï¼ˆ4ï¼‰è°ƒç”¨application"></a>ï¼ˆ4ï¼‰è°ƒç”¨application</h3><p>è§¦å‘æ¶ˆæ¯æäº¤è‡³é˜Ÿåˆ—</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python</span><br><span class="line">from tasks import add</span><br><span class="line">result = add.delay(<span class="number">1</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ï¼ˆ4ï¼‰åå¯æŸ¥çœ‹<code>Terminals</code>çš„workerç›¸å…³ä¿¡æ¯è¾“å‡º</p>
<h3 id="ï¼ˆ5ï¼‰æŸ¥çœ‹æ‰§è¡Œç»“æœ"><a href="#ï¼ˆ5ï¼‰æŸ¥çœ‹æ‰§è¡Œç»“æœ" class="headerlink" title="ï¼ˆ5ï¼‰æŸ¥çœ‹æ‰§è¡Œç»“æœ"></a>ï¼ˆ5ï¼‰æŸ¥çœ‹æ‰§è¡Œç»“æœ</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result.result</span><br><span class="line"># result: <span class="number">3</span></span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ6ï¼‰ä½¿ç”¨configåŠ è½½Celeryä¿¡æ¯"><a href="#ï¼ˆ6ï¼‰ä½¿ç”¨configåŠ è½½Celeryä¿¡æ¯" class="headerlink" title="ï¼ˆ6ï¼‰ä½¿ç”¨configåŠ è½½Celeryä¿¡æ¯"></a>ï¼ˆ6ï¼‰ä½¿ç”¨configåŠ è½½Celeryä¿¡æ¯</h3><p>é™¤äº†ä¸Šè¿°<code>app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest:guest@127.0.0.1:5672&#39;)</code>çš„æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥å°†Celeryçš„é…ç½®å­˜å…¥<code>celeryconfig.py</code>æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨<code>app.config_from_object</code>åŠ è½½ï¼š</p>
<p><code>tasks.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line">app = Celery(<span class="string">&#x27;task_name&#x27;</span>)</span><br><span class="line">app.config_from_object(<span class="string">&#x27;celery_config&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>celery_config.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line">BROKER_URL = <span class="string">&#x27;amqp://guest:guest@127.0.0.1:5672&#x27;</span>  <span class="comment"># ä¸­é—´ä»¶åœ°å€</span></span><br><span class="line">CELERY_RESULT_BACKEND = <span class="string">&#x27;amqp://&#x27;</span> <span class="comment"># åç«¯: å­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœ</span></span><br><span class="line">CELERY_TIMEZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span>    <span class="comment"># æŒ‡å®šæ—¶åŒºï¼Œä¸æŒ‡å®šé»˜è®¤ä¸º &#x27;UTC&#x27;</span></span><br><span class="line">CELERY_TASK_RESULT_EXPIRES = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> <span class="comment"># ä»»åŠ¡è¿‡æœŸæ—¶é—´</span></span><br><span class="line"></span><br><span class="line">CELERYBEAT_SCHEDULE = &#123;</span><br><span class="line">    <span class="string">&#x27;mybeat&#x27;</span>: &#123;</span><br><span class="line">        <span class="comment"># taskï¼šéœ€è¦æ‰§è¡Œè®¡åˆ’ä»»åŠ¡çš„å‡½æ•°</span></span><br><span class="line">        <span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;tasks.add&#x27;</span>,</span><br><span class="line">        <span class="comment"># é…ç½®è®¡åˆ’ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼ˆ3ç§’ï¼‰</span></span><br><span class="line">        <span class="string">&#x27;schedule&#x27;</span>: timedelta(seconds=<span class="number">3</span>),</span><br><span class="line">        <span class="comment"># ä¼ å…¥è®¡åˆ’ä»»åŠ¡å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">        <span class="string">&#x27;args&#x27;</span>: (<span class="number">1</span>, <span class="number">200</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># â€¦â€¦</span></span><br></pre></td></tr></table></figure>



<h2 id="4-åœ¨Djangoä¸­ä½¿ç”¨ä¿¡å·é‡"><a href="#4-åœ¨Djangoä¸­ä½¿ç”¨ä¿¡å·é‡" class="headerlink" title="4.åœ¨Djangoä¸­ä½¿ç”¨ä¿¡å·é‡"></a>4.åœ¨Djangoä¸­ä½¿ç”¨ä¿¡å·é‡</h2><p>ä¿¡å·é‡ï¼ˆSignalï¼‰ï¼šåœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¯ä»¥å‘é€ä¸€ä¸ªä¿¡å·å»é€šçŸ¥æ³¨å†Œäº†è¿™ä¸ªä¿¡å·çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªå›è°ƒï¼Œåœ¨å›è°ƒé‡Œè¿›è¡Œé€»è¾‘å¤„ç†ã€‚</p>
<h3 id="ï¼ˆ1ï¼‰è‡ªå®šä¹‰ä¿¡å·é‡"><a href="#ï¼ˆ1ï¼‰è‡ªå®šä¹‰ä¿¡å·é‡" class="headerlink" title="ï¼ˆ1ï¼‰è‡ªå®šä¹‰ä¿¡å·é‡"></a>ï¼ˆ1ï¼‰è‡ªå®šä¹‰ä¿¡å·é‡</h3><p><code>event.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> Signal  <span class="comment"># å†…ç½®åº“ </span></span><br><span class="line">mySignal = Signal(providing_args=[<span class="string">&quot;ä¿¡å·å‚æ•°1&quot;</span>,<span class="string">&quot;ä¿¡å·å‚æ•°2&quot;</span>])</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ2ï¼‰åŠ è½½ä¿¡å·é‡-ç»‘å®šå¤„ç†å‡½æ•°"><a href="#ï¼ˆ2ï¼‰åŠ è½½ä¿¡å·é‡-ç»‘å®šå¤„ç†å‡½æ•°" class="headerlink" title="ï¼ˆ2ï¼‰åŠ è½½ä¿¡å·é‡ - ç»‘å®šå¤„ç†å‡½æ•°"></a>ï¼ˆ2ï¼‰åŠ è½½ä¿¡å·é‡ - ç»‘å®šå¤„ç†å‡½æ•°</h3><p><code>__init__.py</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from .event import mySignal</span><br></pre></td></tr></table></figure>

<p><code>apps.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> AppConfig  <span class="comment"># å†…ç½®åº“ </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAppConfig</span>(<span class="params">AppConfig</span>):</span></span><br><span class="line">  name = <span class="string">&quot;app&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">ready</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">from</span> .signals <span class="keyword">import</span> å¤„ç†å‡½æ•°</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ3ï¼‰äº‹ä»¶è§¦å‘-send"><a href="#ï¼ˆ3ï¼‰äº‹ä»¶è§¦å‘-send" class="headerlink" title="ï¼ˆ3ï¼‰äº‹ä»¶è§¦å‘ - send"></a>ï¼ˆ3ï¼‰äº‹ä»¶è§¦å‘ - send</h3><p><code>view.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .event <span class="keyword">import</span> mySignal</span><br><span class="line">mySignal.send(sender=<span class="string">&quot;function or class&quot;</span>, ä¿¡å·å‚æ•°<span class="number">1</span>=<span class="string">&quot;something&quot;</span>, ä¿¡å·å‚æ•°<span class="number">2</span>=<span class="string">&quot;others&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ4ï¼‰æ¥æ”¶ä¿¡å·-æ‰§è¡Œï¼ˆsignals-pyå¤„ç†ä¿¡å·çš„å‡½æ•°ï¼‰"><a href="#ï¼ˆ4ï¼‰æ¥æ”¶ä¿¡å·-æ‰§è¡Œï¼ˆsignals-pyå¤„ç†ä¿¡å·çš„å‡½æ•°ï¼‰" class="headerlink" title="ï¼ˆ4ï¼‰æ¥æ”¶ä¿¡å· + æ‰§è¡Œï¼ˆsignals.pyå¤„ç†ä¿¡å·çš„å‡½æ•°ï¼‰"></a>ï¼ˆ4ï¼‰æ¥æ”¶ä¿¡å· + æ‰§è¡Œï¼ˆ<code>signals.py</code>å¤„ç†ä¿¡å·çš„å‡½æ•°ï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> receiver  <span class="comment"># å†…ç½®åº“ </span></span><br><span class="line"><span class="keyword">from</span> .event <span class="keyword">import</span> mySignal</span><br><span class="line"></span><br><span class="line"><span class="meta">@receiver(<span class="params">mySignal</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> å¤„ç†å‡½æ•°(<span class="params">sender, instance, **kwargs</span>):</span></span><br><span class="line"><span class="comment">#    :param sender: ä¿¡å·å‘é€ç±»</span></span><br><span class="line"><span class="comment">#    :param instance: å®é™…è¦ä¿å­˜çš„å®ä¾‹</span></span><br><span class="line"><span class="comment">#    :param kwargs: post_save å‚æ•°</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;do something&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ5ï¼‰celeryå†…ç½®çš„å‡ ç§ä¿¡å·"><a href="#ï¼ˆ5ï¼‰celeryå†…ç½®çš„å‡ ç§ä¿¡å·" class="headerlink" title="ï¼ˆ5ï¼‰celeryå†…ç½®çš„å‡ ç§ä¿¡å·"></a>ï¼ˆ5ï¼‰celeryå†…ç½®çš„å‡ ç§ä¿¡å·</h3><blockquote>
<p><code>from celery.signals import before_task_publish, task_postrun</code></p>
</blockquote>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">before_task_publish - sender å‘å¸ƒ task ä¹‹å‰ã€‚</span><br><span class="line">after_task_publish - sender å‘å¸ƒ task ä¹‹åã€‚</span><br><span class="line"></span><br><span class="line">task_prerun - receiver æ‰§è¡Œ task ä¹‹å‰ã€‚</span><br><span class="line">task_postrun - receiver æ‰§è¡Œ task ä¹‹åã€‚</span><br><span class="line"></span><br><span class="line">task_retry - receiver æ‰§è¡Œ task æ—¶ï¼Œå‘ç”Ÿã€Œé‡è¯•ã€ã€‚</span><br><span class="line">task_success - receiver æ‰§è¡Œ task æ—¶ï¼Œå‘ç”Ÿã€ŒæˆåŠŸã€ã€‚</span><br><span class="line">task_failure - receiver æ‰§è¡Œ task æ—¶ï¼Œå‘ç”Ÿã€Œå¤±è´¥ã€ã€‚</span><br><span class="line">task_revoked - receiver æ‰§è¡Œ task æ—¶ï¼Œå‘ç”Ÿã€Œæ³¨é”€ã€ã€‚</span><br><span class="line"></span><br><span class="line">task_unknown - receiver æ— æ³•è¾¨è¯†ã€‚å½“ project å’Œ celery çš„ task äº§ç”Ÿè½å·®æ—¶ï¼Œä¼šå‘ç”Ÿçš„çŠ¶å†µã€‚</span><br><span class="line"></span><br><span class="line">è¡¥å……ï¼šbefore_task_publishæä¾›äº†å¾ˆå¤šå‚æ•°ï¼šä»»åŠ¡æ¶ˆæ¯ä½“bodyã€äº¤æ¢å™¨exchangeã€è·¯ç”±é”®routing_keyã€åº”ç”¨å¤´éƒ¨æ˜ å°„headersã€æ¶ˆæ¯å±æ€§propertiesã€å®ä½“åˆ—è¡¨declareã€é‡è¯•ç­–ç•¥retry_policyã€‚ï¼ˆå…·ä½“æè¿°å¯å‚è€ƒå®˜ç½‘ï¼‰</span><br><span class="line"></span><br><span class="line">å…¶ä¸­ headers &#x3D; &#123;&#39;lang&#39;: &#39;py&#39;, &#39;task&#39;: &#39;tasks.add&#39;, &#39;id&#39;: &#39;15856ead-8a38-4a65-95d5-9baffc3c301c&#39;, &#39;shadow&#39;: None, &#39;eta&#39;: None, &#39;expires&#39;: None, &#39;group&#39;: None, &#39;group_index&#39;: None, &#39;retries&#39;: 0, &#39;timelimit&#39;: [None, None], &#39;root_id&#39;: &#39;15856ead-8a38-4a65-95d5-9baffc3c301c&#39;, &#39;parent_id&#39;: None, &#39;argsrepr&#39;: &#39;[1, 200]&#39;, &#39;kwargsrepr&#39;: &#39;&#123;&#125;&#39;, &#39;origin&#39;: &#39;gen29622@JUNMINGGUO-MB0&#39;&#125;</span><br><span class="line"></span><br><span class="line">è¡¥å……: ETAï¼ˆestimated time of arrival, é¢„è®¡åˆ°åº•æ—¶é—´ï¼‰è®©ä½ è®¾ç½®ä¸€ä¸ªæ—¥æœŸå’Œæ—¶é—´ï¼Œåœ¨è¿™ä¸ªæ—¶é—´ä¹‹å‰ä»»åŠ¡å°†è¢«æ‰§è¡Œã€‚ countdown æ˜¯ä¸€ç§ä»¥ç§’ä¸ºå•ä½è®¾ç½®ETAçš„å¿«æ·æ–¹å¼ã€‚ ç¡®ä¿ä»»åŠ¡åœ¨æŒ‡å®šçš„æ—¥æœŸå’Œæ—¶é—´ä¹‹åçš„æŸä¸ªæ—¶é—´æ‰§è¡Œï¼Œä½†ä¸ä¸€å®šåœ¨è¯¥æ—¶é—´æ‰§è¡Œã€‚</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="ï¼ˆ6ï¼‰djangoå†…ç½®çš„å‡ ç§ä¿¡å·"><a href="#ï¼ˆ6ï¼‰djangoå†…ç½®çš„å‡ ç§ä¿¡å·" class="headerlink" title="ï¼ˆ6ï¼‰djangoå†…ç½®çš„å‡ ç§ä¿¡å·"></a>ï¼ˆ6ï¼‰djangoå†…ç½®çš„å‡ ç§ä¿¡å·</h3><blockquote>
<p><code>from django.db.models.signals import pre_save,post_save</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pre_save - modelså¯¹è±¡ä¿å­˜ä¹‹å‰è§¦å‘</span><br><span class="line">post_save - modelså¯¹è±¡ä¿å­˜ä¹‹åè§¦å‘</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ7ï¼‰è‡ªåŠ¨æ”¶é›†å¼‚æ­¥ä»»åŠ¡"><a href="#ï¼ˆ7ï¼‰è‡ªåŠ¨æ”¶é›†å¼‚æ­¥ä»»åŠ¡" class="headerlink" title="ï¼ˆ7ï¼‰è‡ªåŠ¨æ”¶é›†å¼‚æ­¥ä»»åŠ¡"></a>ï¼ˆ7ï¼‰è‡ªåŠ¨æ”¶é›†å¼‚æ­¥ä»»åŠ¡</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app = Celery(<span class="string">&#x27;CELERY_NAME&#x27;</span>)</span><br><span class="line">app.config_from_object(<span class="string">&#x27;settings&#x27;</span>, namespace=<span class="string">&#x27;CELERY&#x27;</span>)</span><br><span class="line">app.autodiscover_tasks()  </span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ8ï¼‰ä½¿ç”¨æ—¥å¿—è®°å½•"><a href="#ï¼ˆ8ï¼‰ä½¿ç”¨æ—¥å¿—è®°å½•" class="headerlink" title="ï¼ˆ8ï¼‰ä½¿ç”¨æ—¥å¿—è®°å½•"></a>ï¼ˆ8ï¼‰ä½¿ç”¨æ—¥å¿—è®°å½•</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery.utils.log <span class="keyword">import</span> get_task_logger                                                     </span><br><span class="line">                                                                                                 </span><br><span class="line">logger = get_task_logger(__name__)                                                               </span><br><span class="line">                                   </span><br><span class="line"><span class="meta">@app.task(<span class="params">bind=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mytask</span>(<span class="params">self</span>):</span></span><br><span class="line">	logger.info(self.request)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bindè®¾ç½®ä¸ºTrueæ—¶ï¼Œmytaskçš„å½¢å‚å¿…é¡»å¡«å†™selfï¼Œå¯é€šè¿‡selfè·å–ä¸Šä¸‹æ–‡ </span></span><br></pre></td></tr></table></figure>

<h2 id="5-ä»»åŠ¡è°ƒåº¦å™¨-Beat"><a href="#5-ä»»åŠ¡è°ƒåº¦å™¨-Beat" class="headerlink" title="5.ä»»åŠ¡è°ƒåº¦å™¨(Beat)"></a>5.ä»»åŠ¡è°ƒåº¦å™¨(Beat)</h2><h3 id="ï¼ˆ1ï¼‰é…ç½®"><a href="#ï¼ˆ1ï¼‰é…ç½®" class="headerlink" title="ï¼ˆ1ï¼‰é…ç½®"></a>ï¼ˆ1ï¼‰é…ç½®</h3><p>åœ¨<code>celeryconfig.py</code>ä¸­é…ç½®<code>CELERYBEAT_SCHEDULE</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CELERYBEAT_SCHEDULE = &#123;</span><br><span class="line">    <span class="string">&#x27;mybeat&#x27;</span>: &#123;</span><br><span class="line">        <span class="comment"># taskï¼šéœ€è¦æ‰§è¡Œè®¡åˆ’ä»»åŠ¡çš„å‡½æ•°(å®Œæ•´è·¯å¾„ï¼šæ–‡ä»¶è·¯å¾„.æ–¹æ³•)</span></span><br><span class="line">        <span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;tasks.add&#x27;</span>,</span><br><span class="line">        <span class="comment"># é…ç½®è®¡åˆ’ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼ˆ3ç§’ï¼‰</span></span><br><span class="line">        <span class="string">&#x27;schedule&#x27;</span>: timedelta(seconds=<span class="number">3</span>),</span><br><span class="line">        <span class="comment"># ä¼ å…¥è®¡åˆ’ä»»åŠ¡å‡½æ•°çš„å‚æ•°</span></span><br><span class="line">        <span class="string">&#x27;args&#x27;</span>: (<span class="number">1</span>, <span class="number">200</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ2ï¼‰å¯åŠ¨å‘¨æœŸæ€§ä»»åŠ¡"><a href="#ï¼ˆ2ï¼‰å¯åŠ¨å‘¨æœŸæ€§ä»»åŠ¡" class="headerlink" title="ï¼ˆ2ï¼‰å¯åŠ¨å‘¨æœŸæ€§ä»»åŠ¡"></a>ï¼ˆ2ï¼‰å¯åŠ¨å‘¨æœŸæ€§ä»»åŠ¡</h3><p>ä»»åŠ¡è°ƒåº¦å™¨ä¼šå‘¨æœŸæ€§ï¼ˆ3ç§’ï¼‰åœ°å¯åŠ¨ä»»åŠ¡ï¼Œå°†éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡å‘é€ç»™ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">celery -A YOUR_TASK_NAME beat --loglevel=INFO [-Q QUEUE_NAME]</span><br><span class="line"># YOUR_TASKä¸ºcleryä»»åŠ¡å</span><br><span class="line"># QUEUE_NAMEä¸ºå¯¹åº”çš„é˜Ÿåˆ—å</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ3ï¼‰æŸ¥çœ‹å‘¨æœŸæ€§ä»»åŠ¡"><a href="#ï¼ˆ3ï¼‰æŸ¥çœ‹å‘¨æœŸæ€§ä»»åŠ¡" class="headerlink" title="ï¼ˆ3ï¼‰æŸ¥çœ‹å‘¨æœŸæ€§ä»»åŠ¡"></a>ï¼ˆ3ï¼‰æŸ¥çœ‹å‘¨æœŸæ€§ä»»åŠ¡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">celery -A YOUR_TASK_NAME worker --loglevel=INFO [-Q QUEUE_NAME] </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> QUEUE_NAME ä¸ºBeaté˜Ÿåˆ—çš„åç§°</span></span><br></pre></td></tr></table></figure>

<h2 id="6-Django-settingå…¶å®ƒç›¸å…³é…ç½®"><a href="#6-Django-settingå…¶å®ƒç›¸å…³é…ç½®" class="headerlink" title="6.Django-settingå…¶å®ƒç›¸å…³é…ç½®"></a>6.Django-settingå…¶å®ƒç›¸å…³é…ç½®</h2><h3 id="ï¼ˆ1ï¼‰å¼‚æ­¥ä»»åŠ¡ç»‘å®šè‡ªå®šä¹‰ä»»åŠ¡é˜Ÿåˆ—å"><a href="#ï¼ˆ1ï¼‰å¼‚æ­¥ä»»åŠ¡ç»‘å®šè‡ªå®šä¹‰ä»»åŠ¡é˜Ÿåˆ—å" class="headerlink" title="ï¼ˆ1ï¼‰å¼‚æ­¥ä»»åŠ¡ç»‘å®šè‡ªå®šä¹‰ä»»åŠ¡é˜Ÿåˆ—å"></a>ï¼ˆ1ï¼‰å¼‚æ­¥ä»»åŠ¡ç»‘å®šè‡ªå®šä¹‰ä»»åŠ¡é˜Ÿåˆ—å</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> kombu <span class="keyword">import</span> Queue, Exchange</span><br><span class="line">CELERY_TASK_QUEUES=(</span><br><span class="line">			Queue(<span class="string">&#x27;é˜Ÿåˆ—å&#x27;</span>,</span><br><span class="line">      	exchange=Exchange(<span class="string">&#x27;é˜Ÿåˆ—å&#x27;</span>),</span><br><span class="line">        routing_key=<span class="string">&#x27;é˜Ÿåˆ—å&#x27;</span>),</span><br><span class="line">			...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">CELERY_TASK_ROUTES=&#123;</span><br><span class="line">    <span class="string">&#x27;æ–‡ä»¶è·¯å¾„.å¼‚æ­¥æ–¹æ³•å&#x27;</span>: <span class="string">&#x27;é˜Ÿåˆ—å&#x27;</span>,</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ2ï¼‰å‘¨æœŸæ€§ä»»åŠ¡"><a href="#ï¼ˆ2ï¼‰å‘¨æœŸæ€§ä»»åŠ¡" class="headerlink" title="ï¼ˆ2ï¼‰å‘¨æœŸæ€§ä»»åŠ¡"></a>ï¼ˆ2ï¼‰å‘¨æœŸæ€§ä»»åŠ¡</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CELERY_BEAT_SCHEDULE=&#123;</span><br><span class="line"> 	 <span class="string">&#x27;å‘¨æœŸæ€§ä»»åŠ¡å&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;å‘¨æœŸæ€§ä»»åŠ¡æ–‡ä»¶è·¯å¾„.å‘¨æœŸæ€§ä»»åŠ¡å&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;schedule&#x27;</span>: <span class="number">60</span>, <span class="comment"># é—´éš”è§¦å‘æ—¶é—´ï¼š60ç§’</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><p>1.å®‰è£…celery</p>
<p>2.å®‰è£…rabbitmq</p>
<p>3.å®è·µcelery + rabbitmq</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">&#x27;tasks&#x27;</span>, broker=<span class="string">&#x27;amqp://guest:guest@127.0.0.1:5672&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>

<p>4.è¿è¡Œcelery</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery -A tasks worker --loglevel=INFO</span><br></pre></td></tr></table></figure>

<p>5.æŸ¥çœ‹å®Œæ•´çš„å‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery worker --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<p>6.è°ƒç”¨ä»»åŠ¡ï¼šä½¿ç”¨<code>delay()</code>è°ƒç”¨ä»»åŠ¡ï¼Œæ˜¯<code>apply_async()</code>çš„å¿«æ·æ–¹å¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tasks <span class="keyword">import</span> add</span><br><span class="line">add.delay(<span class="number">4</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h1 id="ä¸‰ã€Celery-once"><a href="#ä¸‰ã€Celery-once" class="headerlink" title="ä¸‰ã€Celery_once"></a>ä¸‰ã€Celery_once</h1><h2 id="1-ä½œç”¨"><a href="#1-ä½œç”¨" class="headerlink" title="1.ä½œç”¨"></a>1.ä½œç”¨</h2><p>å¯é˜²æ­¢Celeryé‡å¤æ‰§è¡Œç›¸åŒä»»åŠ¡ï¼Œå³é¿å…é˜Ÿåˆ—ä¸­å­˜åœ¨é‡å¤å¼‚æ­¥ä»»åŠ¡ã€‚</p>
<h2 id="2-å®‰è£…"><a href="#2-å®‰è£…" class="headerlink" title="2.å®‰è£…"></a>2.å®‰è£…</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install celery_once</span><br></pre></td></tr></table></figure>

<h2 id="3-å®ç°åŸç†"><a href="#3-å®ç°åŸç†" class="headerlink" title="3.å®ç°åŸç†"></a>3.å®ç°åŸç†</h2><p>é‡‡ç”¨redisåˆ†å¸ƒå¼é”ï¼Œé‡å†™äº†Celeryçš„<code>apply_async()</code>ï¼Œé‡å†™çš„æºç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_async</span>(<span class="params">self, args=<span class="literal">None</span>, kwargs=<span class="literal">None</span>, **options</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Attempts to queues a task.</span></span><br><span class="line"><span class="string">        Will raises an AlreadyQueued exception if already queued.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param \*args: positional arguments passed on to the task.</span></span><br><span class="line"><span class="string">        :param \*\*kwargs: keyword arguments passed on to the task.</span></span><br><span class="line"><span class="string">        :keyword \*\*once: (optional)</span></span><br><span class="line"><span class="string">            :param: graceful: (optional)</span></span><br><span class="line"><span class="string">                If True, wouldn&#x27;t raise an exception if already queued.</span></span><br><span class="line"><span class="string">                Instead will return none.</span></span><br><span class="line"><span class="string">            :param: timeout: (optional)</span></span><br><span class="line"><span class="string">                An `int&#x27; number of seconds after which the lock will expire.</span></span><br><span class="line"><span class="string">                If not set, defaults to 1 hour.</span></span><br><span class="line"><span class="string">            :param: keys: (optional)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">  once_options = options.get(<span class="string">&#x27;once&#x27;</span>, &#123;&#125;)</span><br><span class="line">  once_graceful = once_options.get(</span><br><span class="line">    <span class="string">&#x27;graceful&#x27;</span>, self.once.get(<span class="string">&#x27;graceful&#x27;</span>, <span class="literal">False</span>))</span><br><span class="line">  once_timeout = once_options.get(</span><br><span class="line">    <span class="string">&#x27;timeout&#x27;</span>, self.once.get(<span class="string">&#x27;timeout&#x27;</span>, self.default_timeout))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> options.get(<span class="string">&#x27;retries&#x27;</span>):</span><br><span class="line">    key = self.get_key(args, kwargs)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      self.once_backend.raise_or_lock(key, timeout=once_timeout)</span><br><span class="line">      <span class="keyword">except</span> AlreadyQueued <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> once_graceful:</span><br><span class="line">          <span class="keyword">return</span> EagerResult(<span class="literal">None</span>, <span class="literal">None</span>, states.REJECTED)</span><br><span class="line">        <span class="keyword">raise</span> e</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(QueueOnce, self).apply_async(args, kwargs, **options)</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹å†…å®¹åœ¨äºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> options.get(<span class="string">&#x27;retries&#x27;</span>):</span><br><span class="line">  key = self.get_key(args, kwargs)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    self.once_backend.raise_or_lock(key, timeout=once_timeout)</span><br><span class="line">  <span class="keyword">except</span> AlreadyQueued <span class="keyword">as</span> e:</span><br><span class="line">      <span class="keyword">if</span> once_graceful:</span><br><span class="line">        <span class="keyword">return</span> EagerResult(<span class="literal">None</span>, <span class="literal">None</span>, states.REJECTED)</span><br><span class="line">      <span class="keyword">raise</span> e</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">super</span>(QueueOnce, self).apply_async(args, kwargs, **options)</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ1ï¼‰tryä¸­å»åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨ï¼ˆå°è¯•åŠ é”è¿›è¡Œåˆ¤æ–­ï¼‰ï¼Œè‹¥åŠ é”å¤±è´¥åˆ™è¡¨ç¤ºé˜Ÿåˆ—ä¸­å­˜åœ¨ç›¸åŒå¼‚æ­¥ä»»åŠ¡ï¼Œå› è€Œè§¦å‘<code>except AlreadyQueued</code>ï¼Œå¦‚æœ<code>once_graceful=True</code>åˆ™è¡¨ç¤ºä¸æŠ›é”™ï¼Œåä¹‹è®¾ä¸º<code>False</code>åˆ™<code>raise e</code>ã€‚</p>
<p>ï¼ˆ2ï¼‰æ³¨æ„åˆ°å¦‚æœè§¦å‘<code>AlreadyQueued</code>æ—¶ä¼šè¿”å›<code>EagerResult</code>å¯¹è±¡ï¼Œå…¶ä¸­å®ƒçš„<code>__init__</code>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, <span class="built_in">id</span>, ret_value, state, traceback=<span class="literal">None</span></span>):</span></span><br><span class="line">  <span class="comment"># pylint: disable=super-init-not-called</span></span><br><span class="line">  <span class="comment"># XXX should really not be inheriting from AsyncResult</span></span><br><span class="line">  self.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line">  self._result = ret_value</span><br><span class="line">  self._state = state</span><br><span class="line">  self._traceback = traceback</span><br><span class="line">  self.on_ready = promise()</span><br><span class="line">  self.on_ready(self)</span><br></pre></td></tr></table></figure>

<p>åŸå› åœ¨äºCeleryå¯åŠ¨å‘¨æœŸæ€§ä»»åŠ¡Beatæ—¶ï¼Œä¼šè§¦å‘<code>celery/beat.py</code>ä¸­çš„<code>apply_entry</code>æ–¹æ³•ï¼Œæºç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_entry</span>(<span class="params">self, entry, producer=<span class="literal">None</span></span>):</span></span><br><span class="line">  info(<span class="string">&#x27;Scheduler: Sending due task %s (%s)&#x27;</span>, entry.name, entry.task)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      result = self.apply_async(entry, producer=producer, advance=<span class="literal">False</span>)</span><br><span class="line">  <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:  <span class="comment"># pylint: disable=broad-except</span></span><br><span class="line">      error(<span class="string">&#x27;Message Error: %s\n%s&#x27;</span>,</span><br><span class="line">            exc, traceback.format_stack(), exc_info=<span class="literal">True</span>)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">      debug(<span class="string">&#x27;%s sent. id-&gt;%s&#x27;</span>, entry.task, result.<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>

<p>åˆ†æå¯çŸ¥ï¼Œ<code>apply_entry</code>ä¸­ä¼šè·å–<code>apply_async</code>çš„è¿”å›ç»“æœèµ‹ç»™<code>result</code>ï¼Œå…¶ä¸­å‘å¸ƒå¼‚æ­¥ä»»åŠ¡å¤±è´¥ï¼ˆå½“é˜Ÿåˆ—ä¸­å­˜åœ¨ç›¸åŒä»»åŠ¡æ—¶ï¼‰ï¼Œä¼šè¿›å…¥<code>else</code>åˆ†æ”¯ï¼Œè€Œè¯¥éƒ¨åˆ†éœ€è¦è·å–<code>result.id</code>ï¼Œæ‰€ä»¥<code>EagerResult</code>ä¸­éœ€è¦èµ‹äºˆidå­—æ®µä¸ºNoneï¼Œä»è€Œé¿å…è§¦å‘<code>NoneType has not key â€˜idâ€™</code>ï¼Œè€Œå…¶å®ƒå­—æ®µä¸ºå¯é€‰å­—æ®µï¼Œä¾‹å¦‚_stateï¼Œ_tracebackç­‰ã€‚</p>
<h2 id="4-å¤‡æ³¨"><a href="#4-å¤‡æ³¨" class="headerlink" title="4.å¤‡æ³¨"></a>4.å¤‡æ³¨</h2><p><code>Celery_once</code>å®ç°åŸç†é‡‡ç”¨çš„<code>redis</code>å…±äº«é”ï¼Œå› æ­¤ä¸­é—´ä»¶ï¼ˆbrokerï¼‰ä»…æ”¯æŒ<code>redis</code>ï¼Œä¸æ”¯æŒå…¶å®ƒbrokerï¼Œä¾‹å¦‚<code>rabbitmq</code>ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CELERY_ONCE = &#123;</span><br><span class="line">    <span class="string">&#x27;backend&#x27;</span>: <span class="string">&#x27;celery_once.backends.Redis&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;settings&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;url&#x27;</span>: YOUR_REDIS_URL,</span><br><span class="line">        <span class="string">&#x27;default_timeout&#x27;</span>: <span class="number">600</span>,  <span class="comment"># ä»»åŠ¡ä¸‹å‘å10åˆ†é’Ÿååˆ æ‰å¯¹åº”çš„celery-onceé”ï¼Œå³10åˆ†é’Ÿåè¯¥ä»»åŠ¡å¯é‡æ–°æ”¾å…¥é˜Ÿåˆ—</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å››-Flower-Celery"><a href="#å››-Flower-Celery" class="headerlink" title="å››.Flower-Celery"></a>å››.Flower-Celery</h1><p>Flower-Celeryæ˜¯ä¸€æ¬¾Celeryçš„ç›‘æ§å¯è§†åŒ–å·¥å…·</p>
<h2 id="1-å®‰è£…-1"><a href="#1-å®‰è£…-1" class="headerlink" title="1.å®‰è£…"></a>1.å®‰è£…</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flower</span><br></pre></td></tr></table></figure>

<h2 id="2-å¯åŠ¨"><a href="#2-å¯åŠ¨" class="headerlink" title="2.å¯åŠ¨"></a>2.å¯åŠ¨</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flower -A tasks --port=<span class="number">5555</span></span><br><span class="line"># tasksä¸ºCelery.appåç§°</span><br></pre></td></tr></table></figure>

<h2 id="3-è®¿é—®"><a href="#3-è®¿é—®" class="headerlink" title="3.è®¿é—®"></a>3.è®¿é—®</h2><blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:5555/tasks">http://localhost:5555/tasks</a></p>
</blockquote>
<h2 id="4-å¯è§†åŒ–å±•ç¤º"><a href="#4-å¯è§†åŒ–å±•ç¤º" class="headerlink" title="4.å¯è§†åŒ–å±•ç¤º"></a>4.å¯è§†åŒ–å±•ç¤º</h2><p>![image-20201020162051867](/Users/junmingguo/Library/Application Support/typora-user-images/image-20201020162051867.png)</p>
<h1 id="æ–‡æ¡£è¡¥å……"><a href="#æ–‡æ¡£è¡¥å……" class="headerlink" title="æ–‡æ¡£è¡¥å……"></a>æ–‡æ¡£è¡¥å……</h1><ul>
<li><p>rabbitmq <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/documentation.html">å®˜æ–¹æ–‡æ¡£é“¾æ¥</a></p>
</li>
<li><p>pika <a target="_blank" rel="noopener" href="https://pika.readthedocs.io/en/stable/index.html">å®˜ç½‘æ–‡æ¡£é“¾æ¥</a></p>
</li>
<li><p>Celery  <a target="_blank" rel="noopener" href="https://docs.celeryproject.org/en/v4.4.7/">å®˜æ–¹æ–‡æ¡£é“¾æ¥</a></p>
</li>
<li><p>Celery <a target="_blank" rel="noopener" href="https://www.celerycn.io/">ä¸­æ–‡æ‰‹å†Œ</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/24/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94Rabbitmq&Celery/" data-id="ckn0fva3s000bhltde9419fmc" data-title="æ—¥å¸¸ç¬”è®°â€”â€”Rabbitmq &amp; Celery" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/03/25/%E6%9C%AC%E5%9C%B0%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%BB%9F%E8%AE%A1%E5%B7%A5%E5%85%B7%E2%80%94%E2%80%94Coverage/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          æœ¬åœ°å•å…ƒæµ‹è¯•ç»Ÿè®¡å·¥å…·â€”â€”Coverage
        
      </div>
    </a>
  
  
    <a href="/2021/03/24/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94unittest/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ã„lter</strong>
      <div class="article-nav-title">æ—¥å¸¸ç¬”è®°â€”â€”unittest</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Django/">Django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Notes/">Notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/idea/">idea</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nosql/">nosql</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/07/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94ES%20&%20Kibana%20&%20Logstash/">æ—¥å¸¸ç¬”è®°â€”â€”ES &amp; Kibana &amp; Logstash</a>
          </li>
        
          <li>
            <a href="/2021/04/06/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94Sentry/">æ—¥å¸¸ç¬”è®°â€”â€”Sentry</a>
          </li>
        
          <li>
            <a href="/2021/04/01/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94k8s/">æ—¥å¸¸ç¬”è®°â€”â€”k8s</a>
          </li>
        
          <li>
            <a href="/2021/04/01/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94Python/">æ—¥å¸¸ç¬”è®°â€”â€”Python</a>
          </li>
        
          <li>
            <a href="/2021/03/31/%E6%97%A5%E5%B8%B8%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94Elasticsearch/">æ—¥å¸¸ç¬”è®°â€”â€”Elasticsearch</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 Jimmy Guo<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>