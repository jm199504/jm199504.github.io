<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Django &amp; DRF | Jimmy&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="概述：Django &amp; DRF">
<meta property="og:type" content="article">
<meta property="og:title" content="Django &amp; DRF">
<meta property="og:url" content="http://example.com/2021/04/10/Django/index.html">
<meta property="og:site_name" content="Jimmy&#39;s blog">
<meta property="og:description" content="概述：Django &amp; DRF">
<meta property="og:locale">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/buaFLFKicRoAzXcPN6IVK4d0OEFNZ5C72ib3DM6UBTSsgy5AyaJhTzeZUQ0mPOdWLQ3qyjI3U65r4SVYJos0Kj2g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="og:image" content="https://mmbiz.qpic.cn/mmbiz_png/buaFLFKicRoAzXcPN6IVK4d0OEFNZ5C72m0gv1syNBIH4GtDM2fONJib0Z5KkDLgXY4kYngs7rk05TW5CibRuN8hg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1">
<meta property="article:published_time" content="2021-04-10T03:11:28.388Z">
<meta property="article:modified_time" content="2021-04-10T07:02:42.372Z">
<meta property="article:author" content="Jimmy Guo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mmbiz.qpic.cn/mmbiz_png/buaFLFKicRoAzXcPN6IVK4d0OEFNZ5C72ib3DM6UBTSsgy5AyaJhTzeZUQ0mPOdWLQ3qyjI3U65r4SVYJos0Kj2g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1">
  
    <link rel="alternate" href="/atom.xml" title="Jimmy's blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Jimmy&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Django" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/10/Django/" class="article-date">
  <time class="dt-published" datetime="2021-04-10T03:11:28.388Z" itemprop="datePublished">2021-04-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Django-DRF/">Django & DRF</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Django &amp; DRF
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>概述：Django &amp; DRF</p>
<span id="more"></span>

<p>[TOC]</p>
<h2 id="1-URL-amp-PATH-diff"><a href="#1-URL-amp-PATH-diff" class="headerlink" title="1. URL &amp; PATH (diff)"></a>1. URL &amp; PATH (diff)</h2><p>path 与 url 是两个不同的模块，效果都是响应返回页面，path调用的是python第三方模块或框架，而url则是自定义的模块，如Views下的def函数对应url中的参数值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">url(r&#39;^login&#39;,views.login),</span><br><span class="line"></span><br><span class="line">def login(request):</span><br><span class="line">    return render(request,&#39;login.html&#39;)</span><br></pre></td></tr></table></figure>

<p>主要是版本问题：1.x版本用URL，2.x版本用path </p>
<p>在settings.py中有一个ROOT_URLCONF设置，通过对应url文件匹配请求网址</p>
<h2 id="2-Settings设置redis"><a href="#2-Settings设置redis" class="headerlink" title="2. Settings设置redis"></a>2. Settings设置redis</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis:&#x2F;&#x2F;用户名!密码@地址:端口&#x2F;通道</span><br><span class="line"></span><br><span class="line">redis:&#x2F;&#x2F;:django!root2019@10.101.203.209:6379&#x2F;9</span><br><span class="line"></span><br><span class="line">redis:&#x2F;&#x2F;9.134.104.42:6379</span><br></pre></td></tr></table></figure>

<h2 id="3-导入导出DB"><a href="#3-导入导出DB" class="headerlink" title="3. 导入导出DB"></a>3. 导入导出DB</h2><p>1.导出数据库到JSON文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py dumpdata &gt; db_bak.json</span><br></pre></td></tr></table></figure>

<p>2.JSON文件导入到数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py loaddata db.json</span><br></pre></td></tr></table></figure>

<h2 id="4-cached-property-缓存装饰器"><a href="#4-cached-property-缓存装饰器" class="headerlink" title="4. @cached_property 缓存装饰器"></a>4. @cached_property 缓存装饰器</h2><p><code>cached_property</code>主要实现的功能：被修饰的的方法在第一次计算后将方法作为属性存入对象的<code>__dict__</code>[‘方法名’]，下次读值时直接从<code>__dict__[&#39;getWorkYear&#39;]</code>取结果(eg. )，避免了多次计算。<br>使用限制：只能用于只带默认参数的类</p>
<p>另外，类的静态函数、类函数、普通函数、全局变量以及一些内置的属性都是放在类<code>__dict__</code>中</p>
<p>对象的<code>__dict__</code>中存储了一些<code>self.xxx</code></p>
<p>不使用<code>@cached_property</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, age=<span class="number">0</span></span>):</span></span><br><span class="line">        self.age=age</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getWorkYear</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">65</span>-self.age</span><br><span class="line"></span><br><span class="line">user=User(<span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span>(user.getWorkYear)<span class="comment">#&lt;bound method User.getWorkYear of &lt;__main__.User object at 0A..88&gt;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(user.getWorkYear())   <span class="comment">#45</span></span><br><span class="line"><span class="built_in">print</span>(user.__dict__)  <span class="comment">#&#123;&#x27;age&#x27;: 20&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用<code>@cached_property</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.functional <span class="keyword">import</span> cached_property</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, age=<span class="number">0</span></span>):</span></span><br><span class="line">        self.age=age</span><br><span class="line"><span class="meta">    @cached_property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getWorkYear</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">65</span>-self.age</span><br><span class="line">      </span><br><span class="line">user=User(<span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span>(user.getWorkYear)    <span class="comment">#45</span></span><br><span class="line"><span class="built_in">print</span>(user.getWorkYear())  <span class="comment">#error</span></span><br><span class="line"><span class="built_in">print</span>(user.__dict__)  <span class="comment">#&#123;&#x27;age&#x27;: 20, &#x27;getWorkYear&#x27;: 45&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-select-for-update"><a href="#5-select-for-update" class="headerlink" title="5. select_for_update"></a>5. select_for_update</h2><ol>
<li>该语句必须在事务内使用：<code>with transaction.atomic()</code></li>
<li>返回一个锁住行直到事务结束的查询集，如果数据库支持，它将生成一个<code> SELECT ... FOR UPDATE</code> 语句，所有匹配的行将被锁定，直到事务结束。这意味着可以通过锁防止数据被其它事务修改。</li>
<li>如果其他事务锁定了相关行，那么本查询将被阻塞，直到锁被释放。 如果这不想要使查询阻塞的话，使用select_for_update(nowait=True)。 如果其它事务持有冲突的锁，互斥锁, 那么查询将引发 DatabaseError 异常。</li>
<li>可以使用select_for_update(skip_locked=True)忽略锁定的行，nowait和skip_locked是互斥的，同时设置会导致ValueError。</li>
<li>postgresql，oracle和mysql数据库后端支持select_for_update()，MySQL不支持nowait和skip_locked参数。</li>
<li>使用不支持这些选项的数据库后端（如MySQL）将nowait=True或skip_locked=True转换为select_for_update()将导致抛出DatabaseError异常，这可以防止代码意外终止。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> transaction.atomic():</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">    p = Person.objects.select_for_update().get(<span class="built_in">id</span>=pid) <span class="comment"># 添加行锁</span></span><br><span class="line">  <span class="keyword">except</span> Person.DoesExist:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h2 id="6-generics-ListAPIView-关键字搜索"><a href="#6-generics-ListAPIView-关键字搜索" class="headerlink" title="6. generics.ListAPIView 关键字搜索"></a>6. generics.ListAPIView 关键字搜索</h2><p><code>generics.ListAPIView.filter_backends/search_fields </code>提供了关键字搜索功能</p>
<p>当view中设置了<code>search_fields</code>属性时，才应用<code>SearchFilter</code>类，<code>search_fields</code>属性应该是model中文本类型字段的名称列表，例如<code>CharField</code>或<code>TextField</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.filters <span class="keyword">import</span> SearchFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserListView</span>(<span class="params">generics.ListAPIView</span>):</span></span><br><span class="line">    serializer_class = UserSerializer</span><br><span class="line">    filter_backends = [SearchFilter]</span><br><span class="line">    search_fields = [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="7-action"><a href="#7-action" class="headerlink" title="7. @action"></a>7. @action</h2><p><code>method</code>表示请求方法</p>
<p><code>detail</code>表示该<code>action</code>路径是否与单一资源对应</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">detail=True ====&gt; abc/pk/action</span><br><span class="line">detail=False ====&gt; abc/action</span><br><span class="line"></span><br><span class="line"><span class="meta">@action(<span class="params">methods=[<span class="string">&quot;POST&quot;</span>], detail=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">function_name</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        instance = self.get_object()</span><br><span class="line">        <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<h2 id="8-settings"><a href="#8-settings" class="headerlink" title="8. settings"></a>8. settings</h2><ul>
<li>BASE_DIR: 指向Django项目目录的绝对路径</li>
<li>国际化配置 &amp; 地区</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGE_CODE = <span class="string">&#x27;zh-hans&#x27;</span></span><br><span class="line"></span><br><span class="line">TIME_ZONE = <span class="string">&#x27;Etc/GMT-8&#x27;</span></span><br><span class="line"></span><br><span class="line">USE_I18N = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">USE_L10N = USE_TZ = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">LOCALE_PATHS = (</span><br><span class="line">    os.path.join(SITE_DIR, <span class="string">&#x27;locale&#x27;</span>),</span><br><span class="line">    os.path.join(SITE_DIR, <span class="string">&#x27;locale&#x27;</span>, <span class="string">&#x27;rest_framework&#x27;</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日期 / 时间格式</span></span><br><span class="line">DATETIME_FORMAT = <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line"></span><br><span class="line">DATE_FORMAT = <span class="string">&#x27;%Y-%m-%d&#x27;</span></span><br><span class="line"></span><br><span class="line">TIME_FORMAT = <span class="string">&#x27;%H:%M:%S&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="9-国际化"><a href="#9-国际化" class="headerlink" title="9. 国际化"></a>9. 国际化</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用国际化的代码</span></span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> gettext <span class="keyword">as</span> _</span><br><span class="line">message=_(<span class="string">&#x27;App name must be unique&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">LOCALE_PATHS = (</span><br><span class="line">    os.path.join(SITE_DIR, <span class="string">&#x27;locale&#x27;</span>),</span><br><span class="line">    os.path.join(SITE_DIR, <span class="string">&#x27;locale&#x27;</span>, <span class="string">&#x27;rest_framework&#x27;</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># locale/zh_Hans_LC_MESSAGES/django.po (翻译文件)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#: cd/apps/app/serializers.py:19</span></span><br><span class="line">msgid <span class="string">&quot;App name must be unique&quot;</span></span><br><span class="line">msgstr <span class="string">&quot;应用名称必须唯一&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> shell命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改文本后执行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译执行</span></span><br><span class="line">python manage.py makemessages</span><br><span class="line">python manage.py compilemessages</span><br></pre></td></tr></table></figure>

<h2 id="10-ORM"><a href="#10-ORM" class="headerlink" title="10. ORM"></a>10. ORM</h2><table>
<thead>
<tr>
<th>value</th>
<th>含义</th>
<th>eg</th>
</tr>
</thead>
<tbody><tr>
<td>__gt</td>
<td>&gt;</td>
<td></td>
</tr>
<tr>
<td>__gte</td>
<td>&gt;=</td>
<td></td>
</tr>
<tr>
<td>__lt</td>
<td>&lt;</td>
<td></td>
</tr>
<tr>
<td>__lte</td>
<td>&lt;=</td>
<td></td>
</tr>
<tr>
<td>__exact</td>
<td>精确等于</td>
<td></td>
</tr>
<tr>
<td>__iexact</td>
<td>忽略大小写精确等于</td>
<td></td>
</tr>
<tr>
<td>__contains</td>
<td>包含</td>
<td>like ‘%aaa%’</td>
</tr>
<tr>
<td>__icontains</td>
<td>忽略大小写包含</td>
<td>ilike ‘%aaa%’</td>
</tr>
<tr>
<td>__in</td>
<td>属于</td>
<td>name__in=[10,20]</td>
</tr>
<tr>
<td>__isnull</td>
<td>判空</td>
<td></td>
</tr>
<tr>
<td>__startswith</td>
<td>开头</td>
<td></td>
</tr>
<tr>
<td>__istartswith</td>
<td>忽略大小写开头</td>
<td></td>
</tr>
<tr>
<td>__endswith</td>
<td>结尾</td>
<td></td>
</tr>
<tr>
<td>__iendswith</td>
<td>忽略大小写结尾</td>
<td></td>
</tr>
<tr>
<td>__range</td>
<td>范围</td>
<td></td>
</tr>
<tr>
<td>__year</td>
<td>年</td>
<td></td>
</tr>
<tr>
<td>__month</td>
<td>月</td>
<td></td>
</tr>
<tr>
<td>__day</td>
<td>日</td>
<td></td>
</tr>
</tbody></table>
<p>多表操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(<span class="string">u&#x27;名称&#x27;</span>)</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">B</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    aa = models.ForeignKey(A)</span><br><span class="line"> </span><br><span class="line">B.objects.<span class="built_in">filter</span>(aa__name__contains=<span class="string">&#x27;searchtitle&#x27;</span>)<span class="comment">#查询B表中外键aa所对应的表中字段name包含searchtitle的B表对象。</span></span><br></pre></td></tr></table></figure>

<p>返回QuerySets的API：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">方法名	                	解释</span><br><span class="line">filter()	        		过滤查询对象。</span><br><span class="line">exclude()	        		排除满足条件的对象</span><br><span class="line">annotate()	        	使用聚合函数</span><br><span class="line">order_by()	        	对查询集进行排序</span><br><span class="line">reverse()	        		反向排序</span><br><span class="line">distinct()	        	对查询集去重</span><br><span class="line">values()	        		返回包含对象具体值的字典的QuerySet</span><br><span class="line">values_list()	    		与values()类似，只是返回的是元组而不是字典。</span><br><span class="line">dates()	            	根据日期获取查询集</span><br><span class="line">datetimes()	        	根据时间获取查询集</span><br><span class="line">none()	            	创建空的查询集</span><br><span class="line">all()	            		获取所有的对象</span><br><span class="line">union()	            	并集</span><br><span class="line">intersection()	    	交集</span><br><span class="line">difference()	    		差集</span><br><span class="line">select_related()			附带查询关联对象</span><br><span class="line">prefetch_related()		预先查询</span><br><span class="line">extra()	            	附加SQL查询</span><br><span class="line">defer()	            	不加载指定字段</span><br><span class="line">only()	            	只加载指定的字段</span><br><span class="line">using()	           		选择数据库</span><br><span class="line">select_for_update()		锁住选择的对象，直到事务结束。</span><br><span class="line">raw()	            		接收一个原始的SQL查询</span><br></pre></td></tr></table></figure>

<p>annotate：使用提供的聚合表达式查询对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Count</span><br><span class="line"><span class="comment"># 如果正在操作一个Blog列表，你可能想知道每个Blog有多少Entry</span></span><br><span class="line">q = Blog.objects.annotate(Count(<span class="string">&#x27;entry&#x27;</span>))</span><br><span class="line">q[<span class="number">0</span>].name  <span class="comment"># &#x27;Blogasaurus&#x27;</span></span><br><span class="line">q[<span class="number">0</span>].entry__count  <span class="comment"># 42</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分组查询（根据app和name进行分组）</span></span><br><span class="line">Cluster.enables.values(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;name&#x27;</span>).annotate(repeated_count=Count(<span class="string">&#x27;name&#x27;</span>))\</span><br><span class="line">            .order_by(<span class="string">&#x27;repeated_count&#x27;</span>).<span class="built_in">filter</span>(repeated_count__gt=<span class="number">1</span>).values(<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;repeated_count&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>CURD 示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># insert</span></span><br><span class="line">Model.objects.create()</span><br><span class="line"></span><br><span class="line"><span class="comment"># select</span></span><br><span class="line">Model.objects.<span class="built_in">all</span>()</span><br><span class="line">Model.objects.get(<span class="built_in">id</span>=<span class="number">1</span>)  <span class="comment"># 仅返回一个</span></span><br><span class="line">Model.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;junming&#x27;</span>, price&gt;<span class="number">1000</span>)  <span class="comment"># 返回列表</span></span><br><span class="line">Model.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;junming&#x27;</span>, price&gt;<span class="number">1000</span>).first()/last()  <span class="comment"># 返回列表第一个/最后一个元素</span></span><br><span class="line">Model.objects.exclude(name=<span class="string">&#x27;jimmy&#x27;</span>)  <span class="comment"># 过滤</span></span><br><span class="line">Model.objects.order_by(<span class="string">&quot;id&quot;</span>)  <span class="comment"># 以id升序返回列表</span></span><br><span class="line">Model.objects.order_by(<span class="string">&quot;-id&quot;</span>)  <span class="comment"># 以id降序返回列表</span></span><br><span class="line">Model.objects.order_by(<span class="string">&quot;id&quot;</span>).reverse()  <span class="comment"># 以id降序返回列表</span></span><br><span class="line">Model.objects.count()  <span class="comment"># 总数量</span></span><br><span class="line">Model.objects.<span class="built_in">filter</span>(price__gt=<span class="number">10</span>).exists()  <span class="comment"># 判断价格大于10的数据是否存在</span></span><br><span class="line">Model.objects.exclude(price__gte=<span class="number">10</span>)  <span class="comment"># 排除大于等于10的数据 </span></span><br><span class="line">Model.objects.values(<span class="string">&#x27;id&#x27;</span>)  <span class="comment"># 查看id字段部分数据</span></span><br><span class="line">Model.objects.distinct() <span class="comment"># 去重</span></span><br><span class="line">Model.objects.<span class="built_in">filter</span>(title__contains=<span class="string">&quot;tencent&quot;</span>)  <span class="comment"># 包含字段</span></span><br><span class="line">Model.objects.<span class="built_in">filter</span>(title__icontains=<span class="string">&quot;tencent&quot;</span>)  <span class="comment"># 包含字段(不区分大小写)</span></span><br><span class="line">Model.objects.<span class="built_in">filter</span>(title__startswith=<span class="string">&quot;tencent&quot;</span>)  <span class="comment"># 包含字段（开头）</span></span><br><span class="line">Model.objects.<span class="built_in">filter</span>(title__endswith=<span class="string">&quot;tencent&quot;</span>)  <span class="comment"># 包含字段（开头）</span></span><br><span class="line">Model.objects.get(<span class="built_in">id</span>=<span class="number">1944</span>).__dict__.keys() <span class="comment"># 仅查看字段名</span></span><br><span class="line">Model.objects.<span class="built_in">filter</span>(pub_date__month=<span class="number">10</span>)   <span class="comment"># 10月</span></span><br><span class="line">Model.objects.<span class="built_in">filter</span>(created_at__range=(start_date, end_date))  <span class="comment"># 范围</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># update</span></span><br><span class="line">model.update(name=<span class="string">&#x27;guoguo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># drop</span></span><br><span class="line">model.delete()</span><br><span class="line"></span><br><span class="line"><span class="comment"># save</span></span><br><span class="line">model.save()</span><br><span class="line"></span><br><span class="line"><span class="comment"># values_list 获取元组形式结果（仅获得name和qq字段）</span></span><br><span class="line">authors = Author.objects.values_list(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;qq&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果只需要 1 个字段，可以指定 flat=True，当只传递单字段时，可以传递flat参数，当设置为True时，返回的结果将是单值而不是元组。</span></span><br><span class="line">Author.objects.values_list(<span class="string">&#x27;name&#x27;</span>, flat=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># values 获取字典形式的结果</span></span><br><span class="line">Author.objects.values(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;qq&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出SQL细节，设置LOGGING.loggers.django.db.backends-&gt;level:DEBUG</span></span><br><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;console&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;loggers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;django.db.backends&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span> <span class="keyword">if</span> DEBUG <span class="keyword">else</span> <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Django queryset 执行的 SQL</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">str</span>(Release.objects.<span class="built_in">all</span>().query)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于双下划线的跨表查询</span></span><br><span class="line"><span class="comment">#正向：属性名称__跨表的属性名称 反向：小写类名__跨表的属性名称</span></span><br><span class="line"><span class="comment">#一对多(publish是Book的外键)</span></span><br><span class="line">Book.objects.<span class="built_in">filter</span>(publish__name=<span class="string">&quot;ten&quot;</span>).values_list(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;price&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># F对象：可用于查询属性之间比较</span></span><br><span class="line"><span class="comment"># eg.bread值大于comment值</span></span><br><span class="line">BookInfo.objects.<span class="built_in">filter</span>(bread__gt=F(<span class="string">&#x27;comment&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Q对象：调用（&amp;与）（｜或）（～NOT）</span></span><br><span class="line">Poll.objects.get(</span><br><span class="line">    Q(question__startswith=<span class="string">&#x27;Who&#x27;</span>),</span><br><span class="line">    Q(pub_date=date(<span class="number">2005</span>, <span class="number">5</span>, <span class="number">2</span>)) | Q(pub_date=date(<span class="number">2005</span>, <span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">BookInfo.objects.<span class="built_in">filter</span>(~Q(pk=<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 约束条件</span></span><br><span class="line">constraints = [models.UniqueConstraint(fields=[<span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;name&#x27;</span>], condition=models.Q(is_valid=<span class="literal">True</span>), name=<span class="string">&#x27;unique_app_artifact_name&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日期查询</span></span><br><span class="line">BookInfo.objects.<span class="built_in">filter</span>(public_data__year=<span class="number">2020</span>)</span><br><span class="line">BookInfo.objects.<span class="built_in">filter</span>(public_data__gt=date(<span class="number">2020</span>,<span class="number">1</span>,<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 聚合函数</span></span><br><span class="line"><span class="comment"># 使用aggregate()过滤器，包含 Avg、Count、Max、Min、Sum, aggregate返回值是一个字典类型，eg.&#123;&#x27;聚合类小写__属性名&#x27;: 值&#125;</span></span><br><span class="line">BookInfo.objects.aggregate(Sum(<span class="string">&#x27;bread&#x27;</span>))</span><br><span class="line"><span class="comment"># 另外 count 通常不用aggregate</span></span><br><span class="line">BookInfo.objects.count()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由一到多（常用）</span></span><br><span class="line">book = BookInfo.objects.get(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line">book.peopleinfo_set.<span class="built_in">all</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="11-Models-EnableManager"><a href="#11-Models-EnableManager" class="headerlink" title="11. Models.EnableManager"></a>11. Models.EnableManager</h2><p>Enable功能自定义条件过滤数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enables = EnableManager()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EnableManager</span>(<span class="params">models.Manager</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().get_queryset().<span class="built_in">filter</span>(is_valid=<span class="literal">True</span>)</span><br><span class="line">      </span><br><span class="line"><span class="comment"># Person.enables.filter(name__contains=&#x27;bear&#x27;)</span></span><br></pre></td></tr></table></figure>

<h2 id="12-cookie-amp-session"><a href="#12-cookie-amp-session" class="headerlink" title="12. cookie &amp; session"></a>12. cookie &amp; session</h2><p>cookie</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response.set_cookie(<span class="string">&#x27;number&#x27;</span>, <span class="number">123</span>)  <span class="comment"># 设置</span></span><br><span class="line">request.COOKIES[<span class="string">&#x27;number&#x27;</span>] <span class="comment"># 获取</span></span><br></pre></td></tr></table></figure>

<p>session：Django中默认开启session</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">MIDDLEWARE = [<span class="string">&#x27;django.contrib.sessions.middleware.SessionMiddleware&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定session数据的存储方式</span></span><br><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.db&#x27;</span> <span class="comment"># 默认</span></span><br><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.cache&#x27;</span> <span class="comment"># 缓存，丢失无法找回，比DB方式更快</span></span><br><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.cached_db&#x27;</span> <span class="comment"># 混合村粗，优先从内存中存取，没有则从数据库中存取</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储在数据库中需要在应用中注册session</span></span><br><span class="line">INSTALLED_APPS = [<span class="string">&#x27;django.contrib.sessions&#x27;</span>]  <span class="comment"># 生成一个session表</span></span><br><span class="line"><span class="comment"># 通常包含session_key,session_data,expire_date三个字段</span></span><br></pre></td></tr></table></figure>

<p>设置/获取/清除</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request.session[<span class="string">&#x27;key&#x27;</span>] = <span class="string">&#x27;hello&#x27;</span> <span class="comment"># 以键值对的格式写session</span></span><br><span class="line">request.session.get(<span class="string">&#x27;key&#x27;</span>) <span class="comment"># 根据键读取值</span></span><br><span class="line">request.session.clear() <span class="comment"># 清除所有session，在存储中删除值部分</span></span><br><span class="line"><span class="keyword">del</span> request.session[<span class="string">&#x27;key&#x27;</span>] <span class="comment"># 删除session中的指定键及值，在存储中只删除某个键及对 应的值</span></span><br><span class="line">request.session.set_expiry(value)  <span class="comment"># 设置会话的超时时间，如果没有指定过期时间则两个星期 后过期，若value=None表示永不过期</span></span><br></pre></td></tr></table></figure>

<h2 id="13-授权和认证"><a href="#13-授权和认证" class="headerlink" title="13. 授权和认证"></a>13. 授权和认证</h2><p>认证是通过用户提供的用户ID/密码组合或者Token来验证用户的身份。权限(Permission)的校验发生验证用户身份以后，是由系统根据分配权限确定用户可以访问何种资源以及对这种资源进行何种操作，这个过程也被称为授权(Authorization)。</p>
<p>身份验证是将传入的请求对象(request)与一组标识凭据（例如请求来自的用户或其签名的令牌token）相关联的机制。</p>
<p>用户通过认证后request.user返回Django的User实例，否则返回<code>AnonymousUser</code>的实例。request.auth通常为None。如果使用token认证，request.auth可以包含认证过的token。</p>
<p>Django REST Framework提供了如下几种认证方案:</p>
<ul>
<li>Session认证<code>SessionAuthentication</code>类：此认证方案使用Django的默认session后端进行身份验证。当客户端发送登录请求通过验证后，Django通过session将用户信息存储在服务器中保持用户的请求状态。Session身份验证适用于与你的网站在相同的Session环境中运行的AJAX客户端 (注：这也是Session认证的最大弊端)。</li>
<li>基本认证<code>BasicAuthentication</code>类：此认证方案使用HTTP 基本认证，针对用户的用户名和密码进行认证。使用这种方式后浏览器会跳出登录框让用户输入用户名和密码认证。基本认证通常只适用于测试。</li>
<li>远程认证<code>RemoteUserAuthentication</code>类：此认证方案为用户名不存在的用户自动创建用户实例。这个很少用，具体见文档。</li>
<li>Token认证<code>TokenAuthentication</code>类：该认证方案是DRF提供的使用简单的基于Token的HTTP认证方案。当客户端发送登录请求时，服务器便会生成一个Token并将此Token返回给客户端，作为客户端进行请求的一个标识以后客户端只需带上这个Token前来请求数据即可，无需再次带上用户名和密码。后面我们会详细介绍如何使用这种认证方案。</li>
</ul>
<p>注意：如果你在生产环境下使用BasicAuthentication和<code>TokenAuthentication</code>认证，你必须确保你的API仅在<code>https</code>可用。</p>
<h3 id="13-1-DRF自带认证"><a href="#13-1-DRF自带认证" class="headerlink" title="13.1 DRF自带认证"></a>13.1 DRF自带认证</h3><h4 id="（1）创建超级管理员"><a href="#（1）创建超级管理员" class="headerlink" title="（1）创建超级管理员"></a>（1）创建超级管理员</h4><p>会在<code>auth_user</code>内置表中新增一条数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createsuperuser --username USERNAME --email EMAIL</span><br></pre></td></tr></table></figure>

<h4 id="（2）添加登录入口路由"><a href="#（2）添加登录入口路由" class="headerlink" title="（2）添加登录入口路由"></a>（2）添加登录入口路由</h4><p>该方式前后端不分离，不推荐</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">添加路由<span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">  path(‘admin/’, admin.site.urls),</span><br><span class="line">  path(‘api/’, include(‘rest_framework.urls’))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h4 id="（3）对指定API限制读写验证"><a href="#（3）对指定API限制读写验证" class="headerlink" title="（3）对指定API限制读写验证"></a>（3）对指定API限制读写验证</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Comment.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = CommentSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly)</span><br></pre></td></tr></table></figure>

<h4 id="（4）常用DRF自带权限类"><a href="#（4）常用DRF自带权限类" class="headerlink" title="（4）常用DRF自带权限类"></a>（4）常用DRF自带权限类</h4><p>除了<code>IsAuthenticatedOrReadOnly</code> 类，DRF自带的常用权限类还包括：</p>
<ul>
<li>IsAuthenticated类：仅限已经通过身份验证的用户访问；</li>
<li>AllowAny类：允许任何用户访问；</li>
<li>IsAdminUser类：仅限管理员访问；</li>
<li>DjangoModelPermissions类：只有在用户经过身份验证并分配了相关模型权限时，才会获得授权访问相关模型。</li>
<li>DjangoModelPermissionsOrReadOnly类：与前者类似，但可以给匿名用户访问API的可读权限。</li>
<li>DjangoObjectPermissions类：只有在用户经过身份验证并分配了相关对象权限时，才会获得授权访问相关对象。通常与django-gaurdian联用实现对象级别的权限控制。</li>
</ul>
<h4 id="（5）自定义权限类"><a href="#（5）自定义权限类" class="headerlink" title="（5）自定义权限类"></a>（5）自定义权限类</h4><p><code>IsAuthenticatedOrReadOnly</code> 类并不能实现只有文章 article 的创建者才可以更新或删除它，这时我们还需要自定义一个名为<code>IsOwnerOrReadOnly</code> 的权限类，把它加入到ArticleDetail视图里。</p>
<p>首先我们在blog文件夹下创建permissions.py，添加如下代码：</p>
<p><em># blog/permissions.py</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsOwnerOrReadOnly</span>(<span class="params">permissions.BasePermission</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    自定义权限只允许对象的创建者才能编辑它。&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_object_permission</span>(<span class="params">self, request, view, obj</span>):</span></span><br><span class="line">        <span class="comment"># 读取权限被允许用于任何请求，</span></span><br><span class="line">        <span class="comment"># 所以我们始终允许 GET，HEAD 或 OPTIONS 请求。</span></span><br><span class="line">        <span class="keyword">if</span> request.method <span class="keyword">in</span> permissions.SAFE_METHODS:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="comment"># 写入权限只允许给 article 的作者。</span></span><br><span class="line">        <span class="keyword">return</span> obj.author == request.user</span><br></pre></td></tr></table></figure>

<p><em>#blog/views.py</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"><span class="keyword">from</span> .permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># important</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetail</span>(<span class="params">generics.RetrieveUpdateDestroyAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class =ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly, IsOwnerOrReadOnly)</span><br></pre></td></tr></table></figure>

<h4 id="（6）设置权限的方式"><a href="#（6）设置权限的方式" class="headerlink" title="（6）设置权限的方式"></a>（6）设置权限的方式</h4><p>在前面的案例中，我们都是在基于类的API视图里通过<strong>permission_classes</strong>属性设置的权限类。如果你有些权限是全局或全站通用的，你还可以在settings.py中使用 <code>DEFAULT_PERMISSION_CLASSES</code> 全局设置默认权限策略。</p>
<p>例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.IsAuthenticated&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果未指定，则此设置默认为允许无限制访问：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: (</span><br><span class="line">   <span class="string">&#x27;rest_framework.permissions.AllowAny&#x27;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>基于函数的视图编写API，你可以按如下方式给你的函数视图添加权限：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view, permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@permission_classes(<span class="params">(<span class="params">IsAuthenticated, </span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example_view</span>(<span class="params">request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">    content = &#123;</span><br><span class="line">        <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;request was permitted&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Response(content)</span><br></pre></td></tr></table></figure>

<h4 id="（7）总结-DRF-认证方案"><a href="#（7）总结-DRF-认证方案" class="headerlink" title="（7）总结 DRF 认证方案"></a>（7）总结 DRF 认证方案</h4><p>方式1：settings.py中设置默认的全局认证方案</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.BasicAuthentication&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.SessionAuthentication&#x27;</span>,</span><br><span class="line">    )&#125;</span><br></pre></td></tr></table></figure>

<p>方式2：基于类的视图(CBV)中使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> SessionAuthentication, BasicAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    authentication_classes = (SessionAuthentication, BasicAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated,)</span><br></pre></td></tr></table></figure>

<p>方式3：函数视图中使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@authentication_classes(<span class="params">(<span class="params">SessionAuthentication, BasicAuthentication</span>)</span>)</span></span><br><span class="line"><span class="meta">@permission_classes(<span class="params">(<span class="params">IsAuthenticated,</span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example_view</span>(<span class="params">request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">    content = &#123;</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: unicode(request.user),  <span class="comment"># `django.contrib.auth.User` 实例。</span></span><br><span class="line">        <span class="string">&#x27;auth&#x27;</span>: unicode(request.auth),  <span class="comment"># None</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Response(content)</span><br></pre></td></tr></table></figure>

<p>自定义的认证方案，要继承<code>BaseAuthentication</code>类并且重写<code>.authenticate(self, request)</code>方法。如果认证成功，该方法应返回<code>(user, auth)</code>的二元元组，否则返回<code>None</code>。</p>
<p>在某些情况下，你可能不想返回<code>None</code>，而是希望从<code>.authenticate()</code>方法抛出<code>AuthenticationFailed</code>异常。</p>
<p>通常你应该采取的方法是：</p>
<ul>
<li>如果不尝试验证，返回<code>None</code>。还将检查任何其他正在使用的身份验证方案。</li>
<li>如果尝试验证但失败，则抛出<code>AuthenticationFailed</code>异常。无论任何权限检查也不检查任何其他身份验证方案，立即返回错误响应。</li>
</ul>
<p>你也可以重写<code>.authenticate_header(self, request)</code>方法。如果实现该方法，则应返回一个字符串，该字符串将用作<code>HTTP 401 Unauthorized</code>响应中的<code>WWW-Authenticate</code>头的值。</p>
<p>如果<code>.authenticate_header()</code>方法未被重写，则认证方案将在未验证的请求被拒绝访问时返回<code>HTTP 403 Forbidden</code>响应。</p>
<p>示例</p>
<p>以下示例将以自定义请求标头中名称为’X_USERNAME’提供的用户名作为用户对任何传入请求进行身份验证，其它类似自定义认证需求比如支持用户同时按用户名或email进行验证。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> authentication</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleAuthentication</span>(<span class="params">authentication.BaseAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        username = request.META.get(<span class="string">&#x27;X_USERNAME&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.objects.get(username=username)</span><br><span class="line">        <span class="keyword">except</span> User.DoesNotExist:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">&#x27;No such user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (user, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<h3 id="13-2-Token认证"><a href="#13-2-Token认证" class="headerlink" title="13.2 Token认证"></a>13.2 Token认证</h3><h4 id="（1）前后端分离推荐token认证"><a href="#（1）前后端分离推荐token认证" class="headerlink" title="（1）前后端分离推荐token认证"></a>（1）前后端分离推荐token认证</h4><ul>
<li>Token无需存储降低服务器成本，session是将用户信息存储在服务器中的，当用户量增大时服务器的压力也会随着增大。</li>
<li>防御CSRF跨站伪造请求攻击，session是基于cookie进行用户识别的, cookie如果被截获，用户信息就容易泄露。</li>
<li>扩展性强，session需要存储无法共享，当搭建了多个服务器时其他服务器无法获取到session中的验证数据用户无法验证成功。而Token可以实现服务器间共享，这样不管哪里都可以访问到。</li>
<li>Token可以减轻服务器的压力，减少频繁的查询数据库。</li>
<li>支持跨域访问, 适用于移动平台应用</li>
</ul>
<h4 id="（2）TokenAuthentication"><a href="#（2）TokenAuthentication" class="headerlink" title="（2）TokenAuthentication"></a>（2）TokenAuthentication</h4><p>DRF自带的<code>TokenAuthentication</code>方案可以实现基本的token认证，整个流程如下：</p>
<p>首先，你需要将修改settings.py, 加入如下app。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;rest_framework.authtoken&#x27;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>其次，你需要为你的用户生成令牌(token)。如果你希望在创建用户时自动生成token，你可以借助Django的信号(signals)实现，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.db.models.signals <span class="keyword">import</span> post_save</span><br><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> receiver</span><br><span class="line"><span class="keyword">from</span> rest_framework.authtoken.models <span class="keyword">import</span> Token</span><br><span class="line"></span><br><span class="line"><span class="meta">@receiver(<span class="params">post_save, sender=settings.AUTH_USER_MODEL</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_auth_token</span>(<span class="params">sender, instance=<span class="literal">None</span>, created=<span class="literal">False</span>, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> created:</span><br><span class="line">        Token.objects.create(user=instance)</span><br></pre></td></tr></table></figure>

<p>如果你已经创建了一些用户，则可以打开shell为所有现有用户生成令牌，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework.authtoken.models <span class="keyword">import</span> Token</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> User.objects.<span class="built_in">all</span>():    </span><br><span class="line">    Token.objects.get_or_create(user=user)</span><br></pre></td></tr></table></figure>

<p>你还可以在<code>admin.py</code>中给用户创建token，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authtoken.admin <span class="keyword">import</span> TokenAdmin</span><br><span class="line">TokenAdmin.raw_id_fields = [<span class="string">&#x27;user&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>从3.6.4起，你还可以使用如下命令为一个指定用户新建或重置token。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./manage.py drf_create_token &lt;username&gt; <span class="comment"># 新建</span></span><br><span class="line">./manage.py drf_create_token -r &lt;username&gt; <span class="comment"># 重置</span></span><br></pre></td></tr></table></figure>

<p>接下来，你需要暴露用户获取token的url地址(API端点).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authtoken <span class="keyword">import</span> views</span><br><span class="line">urlpatterns += [</span><br><span class="line">    url(<span class="string">r&#x27;^api-token-auth/&#x27;</span>, views.obtain_auth_token)]</span><br></pre></td></tr></table></figure>

<p>这样每当用户使用form表单或JSON将有效的<code>username</code>和<code>password</code>字段POST提交到以上视图时，<code>obtain_auth_token</code>视图将返回如下JSON响应：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">&#x27;token&#x27;</span> : <span class="string">&#x27;9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b&#x27;</span> &#125;</span><br></pre></td></tr></table></figure>

<p>客户端拿到token后可以将其存储到本地cookie或localstorage里，下次发送请求时把token包含在<code>Authorization`` </code>HTTP头即可，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b</span><br></pre></td></tr></table></figure>

<p>你还可以通过curl工具来进行简单测试。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http://127.0.0.1:8000/api/example/ -H <span class="string">&#x27;Authorization: Token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b&#x27;</span></span><br></pre></td></tr></table></figure>

<p>默认的<code>obtain_auth_token</code>视图返回的json响应数据是非常简单的，只有token一项。如果你希望返回更多信息，比如用户id或email，就就要通过继承ObtainAuthToken类量身定制这个视图，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authtoken.views <span class="keyword">import</span> ObtainAuthToken</span><br><span class="line"><span class="keyword">from</span> rest_framework.authtoken.models <span class="keyword">import</span> Token</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomAuthToken</span>(<span class="params">ObtainAuthToken</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request,*args,**kwargs</span>):</span></span><br><span class="line">        serializer =self.serializer_class(data=request.data,</span><br><span class="line">                                           context=&#123;<span class="string">&#x27;request&#x27;</span>: request&#125;)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        user = serializer.validated_data[<span class="string">&#x27;user&#x27;</span>]</span><br><span class="line">        token, created =Token.objects.get_or_create(user=user)</span><br><span class="line">        returnResponse(&#123;</span><br><span class="line">            <span class="string">&#x27;token&#x27;</span>: token.key,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user.pk,</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: user.email</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>

<p>然后修改urls.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns +=[</span><br><span class="line">    path(<span class="string">&#x27;api-token-auth/&#x27;</span>,CustomAuthToken.as_view())]</span><br></pre></td></tr></table></figure>

<p>最后一步，DRF的TokenAuthentication类会从请求头中获取Token，验证其有效性。如果token有效，返回request.user。至此，整个token的签发和验证就完成了。</p>
<h3 id="13-3-JWT认证"><a href="#13-3-JWT认证" class="headerlink" title="13.3 JWT认证"></a>13.3 JWT认证</h3><h4 id="（1）Json-Web-Token及工作原理"><a href="#（1）Json-Web-Token及工作原理" class="headerlink" title="（1）Json Web Token及工作原理"></a>（1）Json Web Token及工作原理</h4><p>JSON Web Token（JWT）是一种开放标准，它定义了一种紧凑且自包含的方式，用于各方之间安全地将信息以JSON对象传输。由于此信息是经过数字签名的，因此可以被验证和信任。JWT用于为应用程序创建访问token，通常适用于API身份验证和服务器到服务器的授权。那么如何理解紧凑和自包含这两个词的含义呢?</p>
<ul>
<li><strong>紧凑</strong>：就是说这个数据量比较少，可以通过url参数，http请求提交的数据以及http header多种方式来传递。</li>
<li><strong>自包含</strong>：这个字符串可以包含很多信息，比如用户id，用户名，订单号id等，如果其他人拿到该信息，就可以拿到关键业务信息。</li>
</ul>
<p>那么JWT认证是如何工作的呢? 首先客户端提交用户登录信息验证身份通过后，服务器生成一个用于证明用户身份的令牌(token)，也就是一个加密后的长字符串，并将其发送给客户端。在后续请求中，客户端以各种方式(比如通过url参数或者请求头)将这个令牌发送回服务器，服务器就知道请求来自哪个特定身份的用户了。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/buaFLFKicRoAzXcPN6IVK4d0OEFNZ5C72ib3DM6UBTSsgy5AyaJhTzeZUQ0mPOdWLQ3qyjI3U65r4SVYJos0Kj2g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>JSON Web Token由三部分组成，这些部分由点（.）分隔，分别是header(头部)，payload(有效负载)和signature(签名)。</p>
<ul>
<li><strong>header(头部)</strong>: 识别以何种算法来生成签名；</li>
<li><strong>pyload(有效负载)</strong>: 用来存放实际需要传递的数据；</li>
<li><strong>signature(签名):</strong> 安全验证token有效性，防止数据被篡改。</li>
</ul>
<p>通过http传输的数据实际上是加密后的JWT，它是由两个点分割的base64-URL长字符串组成，解密后我们可以得到header, payload和signature三部分。我们可以简单的使用 <a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a> 官网来生成或解析一个JWT，如下所示：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/buaFLFKicRoAzXcPN6IVK4d0OEFNZ5C72m0gv1syNBIH4GtDM2fONJib0Z5KkDLgXY4kYngs7rk05TW5CibRuN8hg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h4 id="（2）Django中如何使用JWT认证"><a href="#（2）Django中如何使用JWT认证" class="headerlink" title="（2）Django中如何使用JWT认证"></a>（2）Django中如何使用JWT认证</h4><p>django-rest-framework-simplejwt为Django REST框架提供了JSON Web令牌认证后端。它提供一组保守的默认功能来涵盖了JWT的最常见用例。它还非常容易扩展。</p>
<p>使用pip安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework-simplejwt</span><br></pre></td></tr></table></figure>

<p>其次需要告诉DRF我们使用jwt认证作为后台认证方案。修改myproject/settings.py：</p>
<p>#myproject/settings.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_FILTER_BACKENDS&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;django_filters.rest_framework.DjangoFilterBackend&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework_simplejwt.authentication.JWTAuthentication&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来需要提供用户可以获取和刷新token的urls地址，这两个urls分别对应TokenObtainPairView和TokenRefreshView两个视图。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> reviews.views <span class="keyword">import</span> ProductViewSet, ImageViewSet</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;product&#x27;</span>, ProductViewSet, basename=<span class="string">&#x27;Product&#x27;</span>)</span><br><span class="line">router.register(<span class="string">r&#x27;image&#x27;</span>, ImageViewSet, basename=<span class="string">&#x27;Image&#x27;</span>)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;token/&#x27;</span>, TokenObtainPairView.as_view(), name=<span class="string">&#x27;token_obtain_pair&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;token/refresh/&#x27;</span>, TokenRefreshView.as_view(), name=<span class="string">&#x27;token_refresh&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</span><br></pre></td></tr></table></figure>

<p>最后可以开始使用postman测试了。通过POST方法发送登录请求到/token/, 请求数据包括username和password。如果登录成功，你将得到两个长字符串，一个是access token(访问令牌)，还有一个是refresh token(刷新令牌)</p>
<p>假如你有一个受保护的视图(比如这里的/image/)，权限(permission_classes)是IsAuthenticated，只有验证用户才可访问。访问这个保护视图时你只需要在请求头的Authorization选项里输入你刚才获取的access token即可</p>
<p>不给这个access token默认只有5分钟有效。5分钟过后，当你再次访问保护视图时，你将得到如下token已失效或过期的提示</p>
<p>那么问题来了，Simple JWT中的access token默认有效期是5分钟，那么refresh token默认有效期是多长呢? 答案是24小时。</p>
<h4 id="（3）更改Simple-JWT的默认设置"><a href="#（3）更改Simple-JWT的默认设置" class="headerlink" title="（3）更改Simple JWT的默认设置"></a>（3）更改Simple JWT的默认设置</h4><p>Simple JWT的默认设置如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">DEFAULTS = &#123;</span><br><span class="line">    <span class="string">&#x27;ACCESS_TOKEN_LIFETIME&#x27;</span>: timedelta(minutes=<span class="number">5</span>),</span><br><span class="line">    <span class="string">&#x27;REFRESH_TOKEN_LIFETIME&#x27;</span>: timedelta(days=<span class="number">1</span>),</span><br><span class="line">    <span class="string">&#x27;ROTATE_REFRESH_TOKENS&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&#x27;BLACKLIST_AFTER_ROTATION&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;ALGORITHM&#x27;</span>: <span class="string">&#x27;HS256&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SIGNING_KEY&#x27;</span>: settings.SECRET_KEY,</span><br><span class="line">    <span class="string">&#x27;VERIFYING_KEY&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;AUDIENCE&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;ISSUER&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;AUTH_HEADER_TYPES&#x27;</span>: (<span class="string">&#x27;Bearer&#x27;</span>,),</span><br><span class="line">    <span class="string">&#x27;USER_ID_FIELD&#x27;</span>: <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;USER_ID_CLAIM&#x27;</span>: <span class="string">&#x27;user_id&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;AUTH_TOKEN_CLASSES&#x27;</span>: (<span class="string">&#x27;rest_framework_simplejwt.tokens.AccessToken&#x27;</span>,),</span><br><span class="line">    <span class="string">&#x27;TOKEN_TYPE_CLAIM&#x27;</span>: <span class="string">&#x27;token_type&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;JTI_CLAIM&#x27;</span>: <span class="string">&#x27;jti&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;SLIDING_TOKEN_REFRESH_EXP_CLAIM&#x27;</span>: <span class="string">&#x27;refresh_exp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SLIDING_TOKEN_LIFETIME&#x27;</span>: timedelta(minutes=<span class="number">5</span>),</span><br><span class="line">    <span class="string">&#x27;SLIDING_TOKEN_REFRESH_LIFETIME&#x27;</span>: timedelta(days=<span class="number">1</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要覆盖Simple JWT的默认设置，可以修改settings.py, 如下所示。下例将refresh token的有效期改为了15天。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line">SIMPLE_JWT = &#123;</span><br><span class="line">    <span class="string">&#x27;REFRESH_TOKEN_LIFETIME&#x27;</span>: timedelta(days=<span class="number">15</span>),</span><br><span class="line">    <span class="string">&#x27;ROTATE_REFRESH_TOKENS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（4）自定义令牌-token"><a href="#（4）自定义令牌-token" class="headerlink" title="（4）自定义令牌(token)"></a>（4）自定义令牌(token)</h4><p>如果你对Simple JWT返回的access token进行解码，你会发现这个token的payload数据部分包括token类型，token失效时间，jti(一个类似随机字符串）和user_id。如果你希望在payload部分提供更多信息，比如用户的username，这时你就要自定义令牌(token)了。</p>
<p>编写你的myapp/seralizers.py，添加如下代码。该序列化器继承了TokenObtainPairSerializer类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.serializers <span class="keyword">import</span> TokenObtainPairSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTokenObtainPairSerializer</span>(<span class="params">TokenObtainPairSerializer</span>):</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_token</span>(<span class="params">cls, user</span>):</span></span><br><span class="line">        token = <span class="built_in">super</span>(MyTokenObtainPairSerializer, cls).get_token(user)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add custom claims</span></span><br><span class="line">        token[<span class="string">&#x27;username&#x27;</span>] = user.username</span><br><span class="line">        <span class="keyword">return</span> token</span><br></pre></td></tr></table></figure>

<p>不使用Simple JWT提供的默认视图，使用自定义视图。修改myapp/views.py, 添加如下代码：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> TokenObtainPairView</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> AllowAny</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> MyTokenObtainPairSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObtainTokenPairView</span>(<span class="params">TokenObtainPairView</span>):</span></span><br><span class="line">    permission_classes = (AllowAny,)</span><br><span class="line">    serializer_class = MyTokenObtainPairSerializer</span><br></pre></td></tr></table></figure>

<p>修改myproject/urls.py, 添加如下代码，将/token/指向新的自定义的视图。注意：本例中的app名为reviews，所以是从reviews.views导入的MyObtainTokenPairView。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> reviews.views <span class="keyword">import</span> ProductViewSet, ImageViewSet, MyObtainTokenPairView</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> TokenRefreshView</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;product&#x27;</span>, ProductViewSet, basename=<span class="string">&#x27;Product&#x27;</span>)</span><br><span class="line">router.register(<span class="string">r&#x27;image&#x27;</span>, ImageViewSet, basename=<span class="string">&#x27;Image&#x27;</span>)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;token/&#x27;</span>, MyObtainTokenPairView.as_view(), name=<span class="string">&#x27;token_obtain_pair&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;token/refresh/&#x27;</span>, TokenRefreshView.as_view(), name=<span class="string">&#x27;token_refresh&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</span><br></pre></td></tr></table></figure>

<p>重新发送POST请求到/token/，你将获得新的access token和refresh token</p>
<p>对重新获取的access token进行解码，你将看到payload部分多了username的内容，是不是很酷? 在实际API开发过程中，通过Json Web Token传递更多数据非常有用。</p>
<h4 id="（5）自定义认证后台-Backend"><a href="#（5）自定义认证后台-Backend" class="headerlink" title="（5）自定义认证后台(Backend)"></a>（5）自定义认证后台(Backend)</h4><p>上面的演示案例是通过用户名和密码登录的，如果我们希望后台同时支持邮箱/密码，手机/密码组合登录怎么办? 这时我们还需要自定义认证后台(Backend)。</p>
<p>修改users/views.py, 添加如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.backends <span class="keyword">import</span> ModelBackend</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCustomBackend</span>(<span class="params">ModelBackend</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request, username=<span class="literal">None</span>, password=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.objects.get(Q(username=username) | Q(email=username) )</span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>修改myproject/settings.py, 把你自定义的验证方式添加到AUTHENTICATION_BACKENDS里去。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AUTHENTICATION_BACKENDS = (</span><br><span class="line">    <span class="string">&#x27;users.views.MyCustomBackend&#x27;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>修改好后，你使用postman发送邮箱/密码组合到/token/，将同样可以获得access token和refresh token</p>
<h2 id="14-DRF-分页"><a href="#14-DRF-分页" class="headerlink" title="14. DRF 分页"></a>14. DRF 分页</h2><p>Django REST Framework提供3种分页类</p>
<ul>
<li>PageNumberPagination类：简单分页器。支持用户按?page=3这种方式查询，你可以通过page_size这个参数手动指定每页展示给用户数据的数量。它还支持用户按?page=3&amp;size=10这种更灵活的方式进行查询，这样用户不仅可以选择页码，还可以选择每页展示数据的数量。对于第二种情况，你通常还需要设置max_page_size这个参数限制每页展示数据的最大数量，以防止用户进行恶意查询(比如size=10000), 这样一页展示1万条数据将使分页变得没有意义。</li>
<li>LimitOffsetPagination类：偏移分页器。支持用户按?limit=20&amp;offset=100这种方式进行查询。offset是查询数据的起始点，limit是每页展示数据的最大条数，类似于page_size。当你使用这个类时，你通常还需要设置max_limit这个参数来限制展示给用户数据的最大数量。</li>
<li>CursorPagination类：加密分页器。这是DRF提供的加密分页查询，仅支持用户按响应提供的上一页和下一页链接进行分页查询，每页的页码都是加密的。使用这种方式进行分页需要你的模型有”created”这个字段，否则你要手动指定ordering排序才能进行使用。</li>
</ul>
<h3 id="（1）使用PageNumberPagination类"><a href="#（1）使用PageNumberPagination类" class="headerlink" title="（1）使用PageNumberPagination类"></a>（1）使用PageNumberPagination类</h3><p>DRF中使用默认分页类的最简单方式就是在settings.py中进行全局配置，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK =&#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>:<span class="string">&#x27;rest_framework.pagination.PageNumberPagination&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;PAGE_SIZE&#x27;</span>:<span class="number">2</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是如果你希望用户按?page=3&amp;size=10这种更灵活的方式进行查询，你就要进行个性化定制。在实际开发过程中，定制比使用默认的分页类更常见，具体做法如下。</p>
<p>第一步: 在app目录下新建pagination.py, 添加如下代码：</p>
<p><em>#blog/pagination.py</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">2</span>   <span class="comment"># default page size</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;size&#x27;</span>  <span class="comment"># ?page=xx&amp;size=??</span></span><br><span class="line">    max_page_size = <span class="number">10</span> <span class="comment"># max page size</span></span><br></pre></td></tr></table></figure>

<p>我们自定义了一个MyPageNumberPagination类，该类继承了PageNumberPagination类。我们通过page_size设置了每页默认展示数据的条数，通过page_size_query_param设置了每页size的参数名以及通过max_page_size设置了每个可以展示的最大数据条数。</p>
<p>第二步：使用自定义的分页类</p>
<p>在基于类的视图中，你可以使用pagination_class这个属性使用自定义的分页类，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> .pagination <span class="keyword">import</span> MyPageNumberPagination</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="comment"># 用一个视图集替代ArticleList和ArticleDetail两个视图</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自行添加，将request.user与author绑定</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自行添加，将request.user与author绑定</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_update</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br></pre></td></tr></table></figure>

<p>当然定制分页类不限于指定page_size和max_page_size这些属性，你还可以改变响应数据的输出格式。比如我们这里希望把next和previous放在一个名为links的key里，我们可以修改MyPageNumberPagination类，重写get_paginated_response方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">2</span>   <span class="comment"># default page size</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;size&#x27;</span>  <span class="comment"># ?page=xx&amp;size=??</span></span><br><span class="line">    max_page_size = <span class="number">10</span> <span class="comment"># max page size</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_paginated_response</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Response(&#123;</span><br><span class="line">            <span class="string">&#x27;links&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;next&#x27;</span>: self.get_next_link(),</span><br><span class="line">                <span class="string">&#x27;previous&#x27;</span>: self.get_previous_link()</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;count&#x27;</span>: self.page.paginator.count,</span><br><span class="line">            <span class="string">&#x27;results&#x27;</span>: data</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>

<p>注意：重写get_paginated_response方法非常有用，你还可以给分页响应数据传递额外的内容，比如code状态码等等。</p>
<p>前面的例子中我们只在单个基于类的视图或视图集中使用到了分页类，你还可以修改settings.py全局使用你自定义的分页类，如下所示。展示效果是一样的，我们就不详细演示了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;blog.pagination.MyPageNumberPagination&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）使用LimitOffsetPagination类"><a href="#（2）使用LimitOffsetPagination类" class="headerlink" title="（2）使用LimitOffsetPagination类"></a>（2）使用LimitOffsetPagination类</h3><p>使用这个分页类最简单的方式就是在settings.py中进行全局配置，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;    </span><br><span class="line">  <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.pagination.LimitOffsetPagination&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>展示效果如下所示，从第6条数据查起，每页展示2条。</p>
<p>你也可以自定义MyLimitOffsetPagination类，在单个视图或视图集中使用，或者全局使用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> LimitOffsetPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLimitOffsetPagination</span>(<span class="params">LimitOffsetPagination</span>):</span></span><br><span class="line">    default_limit = <span class="number">5</span>   <span class="comment"># default limit per age</span></span><br><span class="line">    limit_query_param = <span class="string">&#x27;limit&#x27;</span>  <span class="comment"># default is limit</span></span><br><span class="line">    offset_query_param = <span class="string">&#x27;offset&#x27;</span>  <span class="comment"># default param is offset</span></span><br><span class="line">    max_limit = <span class="number">10</span> <span class="comment"># max limit per age</span></span><br></pre></td></tr></table></figure>

<h3 id="（3）使用CursorPagination类"><a href="#（3）使用CursorPagination类" class="headerlink" title="（3）使用CursorPagination类"></a>（3）使用CursorPagination类</h3><p>全局使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.pagination.CursorPagination&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用CursorPagination类需要你的模型里有created这个字段，否则你需要手动指定ordering字段。这是因为CursorPagination类只能对排过序的查询集进行分页展示。我们的Article模型只有create_date字段，没有created这个字段，所以会报错。</p>
<p>为了解决这个问题，我们需要自定义一个MyCursorPagination类，手动指定按create_date排序, 如下所示：</p>
<p><em>#blog/pagination.py</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> CursorPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyArticleCursorPagination</span>(<span class="params">CursorPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">3</span> <span class="comment"># Default number of records per age</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;page_size&#x27;</span> </span><br><span class="line">    cursor_query_param = <span class="string">&#x27;cursor&#x27;</span> <span class="comment"># Default is cursor</span></span><br><span class="line">    ordering = <span class="string">&#x27;-create_date&#x27;</span></span><br></pre></td></tr></table></figure>

<p>修改settings.py, 使用自己定义的分页类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;blog.pagination.MyArticleCursorPagination&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应效果如下所示，你将得到previous和next分页链接。页码都加密了, 链接里不再显示页码号码。默认每页展示3条记录, 如果使用?page_size=2进行查询，每页你将得到两条记录。</p>
<p>当然由于这个ordering字段与模型相关，我们并不推荐全局使用自定义的CursorPagination类，更好的方式是在GenericsAPIView或视图集viewsets中通过pagination_class属性指定，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> .pagination <span class="keyword">import</span>  MyArticleCursorPagination</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="comment"># 用一个视图集替代ArticleList和ArticleDetail两个视图</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    pagination_class = MyArticleCursorPagination</span><br><span class="line">    <span class="comment"># 自行添加，将request.user与author绑定</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自行添加，将request.user与author绑定</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_update</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br></pre></td></tr></table></figure>

<h3 id="（4）函数类视图中使用分页类"><a href="#（4）函数类视图中使用分页类" class="headerlink" title="（4）函数类视图中使用分页类"></a>（4）函数类视图中使用分页类</h3><p>注意pagination_class属性仅支持在genericsAPIView和视图集viewset中配置使用。如果你使用函数或简单的APIView开发API视图，那么你需要对你的数据进行手动分页，一个具体使用例子如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList0</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List all articles, or create a new article.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        articles = Article.objects.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line">        page = PageNumberPagination()  <span class="comment"># 产生一个分页器对象</span></span><br><span class="line">        page.page_size = <span class="number">3</span>  <span class="comment"># 默认每页显示的多少条记录</span></span><br><span class="line">        page.page_query_param = <span class="string">&#x27;page&#x27;</span>  <span class="comment"># 默认查询参数名为 page</span></span><br><span class="line">        page.page_size_query_param = <span class="string">&#x27;size&#x27;</span>  <span class="comment"># 前台控制每页显示的最大条数</span></span><br><span class="line">        page.max_page_size = <span class="number">10</span>  <span class="comment"># 后台控制显示的最大记录条数，防止用户输入的查询条数过大</span></span><br><span class="line">        ret = page.paginate_queryset(articles, request)</span><br><span class="line">        serializer = ArticleSerializer(ret, many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>

<h2 id="15-序列化器-serializer"><a href="#15-序列化器-serializer" class="headerlink" title="15. 序列化器 serializer"></a>15. 序列化器 serializer</h2><h3 id="15-1-基础知识"><a href="#15-1-基础知识" class="headerlink" title="15.1 基础知识"></a>15.1 基础知识</h3><ul>
<li>序列化及反序列化</li>
</ul>
<p>序列化：将模型类对象转换为字典或者json数据的过程</p>
<p>反序列化：将前端传递的数据保存到模型对象中的过程</p>
<ul>
<li><p>read-only fields，客户端是不能够通过POST或PUT请求提交相关数据进行反序列化的</p>
</li>
<li><p>当校验通过后，可使用<code>serializer.save()</code>进行数据保存，保存时同时调用<code>create()</code>（通常会报错），需要对<code>create()</code>重写，需要传入一个行参<code>validated_data</code>，它是校验之后的字典数据，其中<code>**validated_data</code>是对该字典进行拆包，同理，更新会同时调用<code>update()</code></p>
</li>
</ul>
<ul>
<li>构造</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Serializer(instance=<span class="literal">None</span>, data=empty, **kwarg)</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>（1）用于序列化时，将模型类对象传入instance参数</p>
<p>（2）用于反序列化时，将要被反序列化的数据传入data参数</p>
<p>（3）除了instance和data参数外，在构造Serializer对象时，还可通过context参数额外添加数据，通过context参数附加的数据，可以通过Serializer对象的context属性获取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serializer = AccountSerializer(account, context=&#123;<span class="string">&#x27;request&#x27;</span>: request&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>many参数</li>
</ul>
<ol>
<li><p>序列化器级别：</p>
<p>若被序列化的包含多条数据的查询集QuerySet，可以通过添加<strong>many=True</strong>参数补充说明</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">book_qs = BookInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">serializer = BookInfoSerializer(book_qs, many=<span class="literal">True</span>)</span><br><span class="line">serializer.data</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>字段级别：</p>
<p>如果关联的对象数据不是只有一个，而是包含多个数据，如想序列化图书BookInfo数据，每个BookInfo对象关联的英雄HeroInfo对象可能有多个，此时关联字段类型的指明仍可使用上述几种方式，只是在声明关联字段时，多补充一个many=True参数即可。</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroinfo_set = serializers.PrimaryKeyRelatedField(read_only=<span class="literal">True</span>, many=<span class="literal">True</span>) </span><br></pre></td></tr></table></figure>

<h3 id="15-2-定义-常见序列化方法"><a href="#15-2-定义-常见序列化方法" class="headerlink" title="15.2 定义 - 常见序列化方法"></a>15.2 定义 - 常见序列化方法</h3><h4 id="（1）指定source来源"><a href="#（1）指定source来源" class="headerlink" title="（1）指定source来源"></a>（1）指定source来源</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    author = serializers.ReadOnlyField(source=<span class="string">&quot;author.username&quot;</span>)</span><br><span class="line">    fstatus = serializers.ReadOnlyField(source=<span class="string">&quot;get_status_display&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>)</span><br><span class="line">        <span class="comment"># 其它字段说明</span></span><br><span class="line">        <span class="comment"># db_table：指定自定义数据库表名</span></span><br><span class="line">        <span class="comment"># db_tablespace：数据库表空间，eg.Oracle</span></span><br><span class="line">        <span class="comment"># ordering：Django模型对象返回的记录结果集按照哪一字段进行排序。</span></span><br><span class="line">				<span class="comment"># unique_together：需要通过两个字段保持唯一性时使用。</span></span><br></pre></td></tr></table></figure>

<h4 id="（2）SerializerMethodField自定义方法"><a href="#（2）SerializerMethodField自定义方法" class="headerlink" title="（2）SerializerMethodField自定义方法"></a>（2）SerializerMethodField自定义方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    author = serializers.ReadOnlyField(source=<span class="string">&quot;author.username&quot;</span>)</span><br><span class="line">    status = serializers.ReadOnlyField(source=<span class="string">&quot;get_status_display&quot;</span>)</span><br><span class="line">    cn_status = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cn_status</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">if</span> obj.status == <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;已发表&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> obj.status == <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;草稿&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="（3）使用嵌套序列化器"><a href="#（3）使用嵌套序列化器" class="headerlink" title="（3）使用嵌套序列化器"></a>（3）使用嵌套序列化器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;email&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    author = UserSerializer(read_only=<span class="literal">True</span>) <span class="comment"># 设置required=False表示可以接受匿名用户</span></span><br><span class="line">    status = serializers.ReadOnlyField(source=<span class="string">&quot;get_status_display&quot;</span>)</span><br><span class="line">    cn_status = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cn_status</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">if</span> obj.status == <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;已发表&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> obj.status == <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;草稿&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="（4）设置关联模型的深度depth"><a href="#（4）设置关联模型的深度depth" class="headerlink" title="（4）设置关联模型的深度depth"></a>（4）设置关联模型的深度depth</h4><p>可代替嵌套序列化器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="comment"># author = UserSerializer(read_only=True)</span></span><br><span class="line">    status = serializers.ReadOnlyField(source=<span class="string">&quot;get_status_display&quot;</span>)</span><br><span class="line">    cn_status = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>)</span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cn_status</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">if</span> obj.status == <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;已发表&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> obj.status == <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;草稿&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-3-数据验证-Validation"><a href="#15-3-数据验证-Validation" class="headerlink" title="15.3 数据验证 (Validation)"></a>15.3 数据验证 (Validation)</h3><p>在尝试访问经过验证的数据或保存对象实例之前，反序列化进行数据校验需要调用 <code>is_valid()</code>方法，<code>serializer.errors</code> 属性将包含表示校验错误的信息，<code>serializer.validated_data</code>是校验成功的信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">serializer = CommentSerializer(data=&#123;<span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;foobar&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;baz&#x27;</span>&#125;)</span><br><span class="line">serializer.is_valid()</span><br><span class="line"><span class="comment"># False</span></span><br><span class="line">serializer.errors</span><br><span class="line"><span class="comment"># &#123;&#x27;email&#x27;: [u&#x27;Enter a valid e-mail address.&#x27;], &#x27;created&#x27;: [u&#x27;This field is required.&#x27;]&#125;</span></span><br></pre></td></tr></table></figure>

<p>字典中的每个键都是字段名称，值是与该字段对应的任何错误消息的字符串列表。<code>non_field_errors</code> 键也可能存在，并将列出任何常规验证错误。可以使用 REST framework 设置中的 <code>NON_FIELD_ERRORS_KEY</code> 来自定义 <code>non_field_errors</code> 键的名称。</p>
<h4 id="（1）引发无效数据的异常"><a href="#（1）引发无效数据的异常" class="headerlink" title="（1）引发无效数据的异常"></a>（1）引发无效数据的异常</h4><p>引发无效数据的异常 (Raising an exception on invalid data)</p>
<p><code>.is_valid()</code> 方法使用可选的 <code>raise_exception</code> 标志，如果存在验证错误，将会抛出 <code>serializers.ValidationError</code> 异常。</p>
<p>这些异常由 REST framework 提供的默认异常处理程序自动处理，默认情况下将返回 <code>HTTP 400 Bad Request</code> 响应。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Return a 400 response if the data was invalid.</span></span><br><span class="line">serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h4 id="（2）字段级别验证-validate-field"><a href="#（2）字段级别验证-validate-field" class="headerlink" title="（2）字段级别验证 validate_field"></a>（2）字段级别验证 validate_field</h4><p>字段级别验证 (Field-level validation)</p>
<p>您可以通过向您的 <code>Serializer</code> 子类中添加 <code>.validate_&lt;field_name&gt;</code> 方法来指定自定义字段级的验证。这些类似于 Django 表单中的 <code>.clean_&lt;field_name&gt;</code> 方法。这些方法采用单个参数，即需要验证的字段值。</p>
<p> <code>validate_&lt;field_name&gt;</code> 方法应该返回已验证的值或抛出 <code>serializers.ValidationError</code> 异常。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    title = serializers.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_title</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Check that the article is about Django.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;django&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> value.lower():</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&quot;Article is not about Django&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>

<h4 id="（3）对象级别验证-validate"><a href="#（3）对象级别验证-validate" class="headerlink" title="（3）对象级别验证 validate"></a>（3）对象级别验证 validate</h4><p>对象级别验证 (Object-level validation)</p>
<p>要执行需要访问多个字段的任何其他验证，请添加名为 <code>.validate()</code> 的方法到您的 <code>Serializer</code> 子类中。此方法采用单个参数，该参数是字段值的字典。如果需要，它应该抛出 <code>ValidationError</code> 异常，或者只返回经过验证的值。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    description = serializers.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    start = serializers.DateTimeField()</span><br><span class="line">    finish = serializers.DateTimeField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Check that the start is before the stop.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;start&#x27;</span>] &gt; data[<span class="string">&#x27;finish&#x27;</span>]:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&quot;finish must occur after start&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<h4 id="（4）验证器-Validators-validate-class"><a href="#（4）验证器-Validators-validate-class" class="headerlink" title="（4）验证器 (Validators) validate class"></a>（4）验证器 (Validators) validate class</h4><p>序列化器上的各个字段都可以包含验证器，通过在字段实例上声明，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multiple_of_ten</span>(<span class="params">value</span>):</span></span><br><span class="line">    <span class="keyword">if</span> value % <span class="number">10</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&#x27;Not a multiple of ten&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameRecord</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    score = IntegerField(validators=[multiple_of_ten])</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>DRF还提供了很多可重用的验证器，比如<strong>UniqueValidator</strong>,<strong>UniqueTogetherValidator</strong>等等。通过在内部 <code>Meta</code> 类上声明来包含这些验证器，如下所示。下例中会议房间号和日期的组合必须要是独一无二的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    name = serializers.CharField()</span><br><span class="line">    room_number = serializers.IntegerField(choices=[<span class="number">101</span>, <span class="number">102</span>, <span class="number">103</span>, <span class="number">201</span>])</span><br><span class="line">    date = serializers.DateField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># Each room only has one event per day.</span></span><br><span class="line">        validators = UniqueTogetherValidator(</span><br><span class="line">            queryset=Event.objects.<span class="built_in">all</span>(),</span><br><span class="line">            fields=[<span class="string">&#x27;room_number&#x27;</span>, <span class="string">&#x27;date&#x27;</span>]</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>

<h3 id="15-4-重写序列化器的create和update方法"><a href="#15-4-重写序列化器的create和update方法" class="headerlink" title="15.4 重写序列化器的create和update方法"></a>15.4 重写序列化器的create和update方法</h3><p>假设我们有个Profile模型与User模型是一对一的关系，当用户注册时我们希望把用户提交的数据分别存入User和Profile模型，这时我们就不得不重写序列化器自带的create方法了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    profile = ProfileSerializer()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>)</span><br><span class="line">	  </span><br><span class="line">    <span class="comment"># 通常需要重写create()，同时传入validated_data（是校验之后对数据字典）</span></span><br><span class="line">    <span class="comment"># 其中 **validated_data 是对该字典拆包</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        profile_data = validated_data.pop(<span class="string">&#x27;profile&#x27;</span>)</span><br><span class="line">        user = User.objects.create(**validated_data)</span><br><span class="line">        Profile.objects.create(user=user, **profile_data)</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        profile_data = validated_data.pop(<span class="string">&#x27;profile&#x27;</span>)</span><br><span class="line">        <span class="comment"># 除非应用程序正确地强制始终设置该字段，否则就应该抛出一个需要处理的`DoesNotExist`。</span></span><br><span class="line">        profile = instance.profile</span><br><span class="line"></span><br><span class="line">        instance.username = validated_data.get(<span class="string">&#x27;username&#x27;</span>, instance.username)</span><br><span class="line">        instance.email = validated_data.get(<span class="string">&#x27;email&#x27;</span>, instance.email)</span><br><span class="line">        instance.save()</span><br><span class="line"></span><br><span class="line">        profile.is_premium_member = profile_data.get(</span><br><span class="line">            <span class="string">&#x27;is_premium_member&#x27;</span>,</span><br><span class="line">            profile.is_premium_member</span><br><span class="line">        )</span><br><span class="line">        profile.has_support_contract = profile_data.get(</span><br><span class="line">            <span class="string">&#x27;has_support_contract&#x27;</span>,</span><br><span class="line">            profile.has_support_contract</span><br><span class="line">         )</span><br><span class="line">        profile.save()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>

<h3 id="15-5-关联对象嵌套序列化"><a href="#15-5-关联对象嵌套序列化" class="headerlink" title="15.5 关联对象嵌套序列化"></a>15.5 关联对象嵌套序列化</h3><h4 id="（1）PrimaryKeyRelatedField（主键）"><a href="#（1）PrimaryKeyRelatedField（主键）" class="headerlink" title="（1）PrimaryKeyRelatedField（主键）"></a>（1）PrimaryKeyRelatedField（主键）</h4><p>此字段将被序列化为关联对象的主键。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hbook = serializers.PrimaryKeyRelatedField(label=<span class="string">&#x27;图书&#x27;</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">hbook = serializers.PrimaryKeyRelatedField(label=<span class="string">&#x27;图书&#x27;</span>, queryset=BookInfo.objects.<span class="built_in">all</span>())</span><br></pre></td></tr></table></figure>

<p>指明字段时需要包含read_only=True或者queryset参数：</p>
<p>包含read_only=True参数时，该字段将不能用作反序列化使用</p>
<p>包含queryset参数时，将被用作反序列化时参数校验使用</p>
<p>使用效果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> booktest.serializers <span class="keyword">import</span> HeroInfoSerializer</span><br><span class="line"><span class="keyword">from</span> booktest.models <span class="keyword">import</span> HeroInfo</span><br><span class="line">hero = HeroInfo.objects.get(<span class="built_in">id</span>=<span class="number">6</span>)</span><br><span class="line">serializer = HeroInfoSerializer(hero)</span><br><span class="line">serializer.data</span><br><span class="line"><span class="comment"># &#123;&#x27;id&#x27;: 6, &#x27;hname&#x27;: &#x27;乔峰&#x27;, &#x27;hgender&#x27;: 1, &#x27;hcomment&#x27;: &#x27;降龙十八掌&#x27;, &#x27;hbook&#x27;: 2&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="（2）StringRelatedField（-str-）"><a href="#（2）StringRelatedField（-str-）" class="headerlink" title="（2）StringRelatedField（__str__）"></a>（2）StringRelatedField（<code>__str__</code>）</h4><p>此字段将被序列化为关联对象的字符串表示方式（即__str__方法的返回值）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbook = serializers.StringRelatedField(label=<span class="string">&#x27;图书&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>使用效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;hname&#x27;</span>: <span class="string">&#x27;乔峰&#x27;</span>, <span class="string">&#x27;hgender&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;hcomment&#x27;</span>: <span class="string">&#x27;降龙十八掌&#x27;</span>, <span class="string">&#x27;hbook&#x27;</span>: <span class="string">&#x27;天龙八部&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（3）HyperlinkedRelatedField（url）"><a href="#（3）HyperlinkedRelatedField（url）" class="headerlink" title="（3）HyperlinkedRelatedField（url）"></a>（3）HyperlinkedRelatedField（url）</h4><p>此字段将被序列化为获取关联对象数据的接口链接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbook = serializers.HyperlinkedRelatedField(label=<span class="string">&#x27;图书&#x27;</span>, read_only=<span class="literal">True</span>, view_name=<span class="string">&#x27;books-detail&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>必须指明view_name参数，以便DRF根据视图名称寻找路由，进而拼接成完整URL。</p>
<p>使用效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;hname&#x27;</span>: <span class="string">&#x27;乔峰&#x27;</span>, <span class="string">&#x27;hgender&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;hcomment&#x27;</span>: <span class="string">&#x27;降龙十八掌&#x27;</span>, <span class="string">&#x27;hbook&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:8000/books/2/&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（4）SlugRelatedField（字段）"><a href="#（4）SlugRelatedField（字段）" class="headerlink" title="（4）SlugRelatedField（字段）"></a>（4）SlugRelatedField（字段）</h4><p>此字段将被序列化为关联对象的指定字段数据，slug_field指明使用关联对象的哪个字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbook = serializers.SlugRelatedField(label=<span class="string">&#x27;图书&#x27;</span>, read_only=<span class="literal">True</span>, slug_field=<span class="string">&#x27;bpub_date&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>使用效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &#123;&#x27;id&#x27;: 6, &#x27;hname&#x27;: &#x27;乔峰&#x27;, &#x27;hgender&#x27;: 1, &#x27;hcomment&#x27;: &#x27;降龙十八掌&#x27;, &#x27;hbook&#x27;: datetime.date(1986, 7, 24)&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="（5）使用关联对象的序列化器"><a href="#（5）使用关联对象的序列化器" class="headerlink" title="（5）使用关联对象的序列化器"></a>（5）使用关联对象的序列化器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbook = BookInfoSerializer()</span><br></pre></td></tr></table></figure>


<p>使用效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &#123;&#x27;id&#x27;: 6, &#x27;hname&#x27;: &#x27;乔峰&#x27;, &#x27;hgender&#x27;: 1, &#x27;hcomment&#x27;: &#x27;降龙十八掌&#x27;, &#x27;hbook&#x27;: OrderedDict([(&#x27;id&#x27;, 2), (&#x27;btitle&#x27;, &#x27;天龙八部&#x27;)te&#x27;, &#x27;1986-07-24&#x27;), (&#x27;bread&#x27;, 36), (&#x27;bcomment&#x27;, 40), (&#x27;image&#x27;, None)])&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="（6）重写to-representation方法"><a href="#（6）重写to-representation方法" class="headerlink" title="（6）重写to_representation方法"></a>（6）重写to_representation方法</h4><p>序列化器的每个字段实际都是由该字段类型的to_representation方法决定格式的，可以通过重写该方法来决定格式。</p>
<p>注意，to_representations方法不仅局限在控制关联对象格式上，适用于各个序列化器字段类型。</p>
<p>自定义一个新的关联字段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookRelateField</span>(<span class="params">serializers.RelatedField</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;自定义用于处理图书的字段&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_representation</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Book: %d %s&#x27;</span> % (value.<span class="built_in">id</span>, value.btitle)</span><br><span class="line"><span class="comment"># 指明hbook为BookRelateField类型</span></span><br><span class="line"></span><br><span class="line">hbook = BookRelateField(read_only=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>使用效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &#123;&#x27;id&#x27;: 6, &#x27;hname&#x27;: &#x27;乔峰&#x27;, &#x27;hgender&#x27;: 1, &#x27;hcomment&#x27;: &#x27;降龙十八掌&#x27;, &#x27;hbook&#x27;: &#x27;Book: 2 天龙八部&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="16-CBV"><a href="#16-CBV" class="headerlink" title="16. CBV"></a>16. CBV</h2><p>DRF推荐使用基于类的视图(CBV)开发API, 提供了4种开发CBV开发模式</p>
<ul>
<li>使用基础APIView类</li>
<li>使用Mixins类和GenericAPI类混配（极少使用，不推荐）</li>
<li>使用通用视图generics.*类, 比如 generics.ListCreateAPIView</li>
<li>使用视图集ViewSet和ModelViewSet</li>
</ul>
<p>其中：</p>
<ul>
<li>基础APIView类：可读性最高，代码最多，灵活性最高。当你需要对的API行为进行个性化定制时，建议使用这种方式。</li>
<li>通用generics.*类：可读性好，代码适中，灵活性较高。当你需要对一个模型进行标准的增删查改全部或部分操作时建议使用这种方式。</li>
<li>使用视图集viewset: 可读性较低，代码最少，灵活性最低。当你需要对一个模型进行标准的增删查改的全部操作且不需定制API行为时建议使用这种方式。</li>
</ul>
<h4 id="（1）基础APIView类"><a href="#（1）基础APIView类" class="headerlink" title="（1）基础APIView类"></a>（1）基础APIView类</h4><p>DRF的APIView类继承了Django自带的View类, 一样可以按请求方法调用不同的处理函数，比如get方法处理GET请求，post方法处理POST请求。它不仅支持更多请求方法，而且对Django的request对象进行了封装，可以使用request.data获取用户通过POST, PUT和PATCH方法发过来的数据，而且支持插拔式地配置认证、权限和限流类，举例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> Http404</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List all articles, or create a new article.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        articles = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">        serializer = ArticleSerializer(articles, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        serializer = ArticleSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            <span class="comment"># 注意：手动将request.user与author绑定</span></span><br><span class="line">            serializer.save(author=request.user)</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetail</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Retrieve, update or delete an article instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self, pk</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> Article.objects.get(pk=pk)</span><br><span class="line">        <span class="keyword">except</span> Article.DoesNotExist:</span><br><span class="line">            <span class="keyword">raise</span> Http404</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        article = self.get_object(pk)</span><br><span class="line">        serializer = ArticleSerializer(article)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        article = self.get_object(pk)</span><br><span class="line">        serializer = ArticleSerializer(instance=article, data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">        article = self.get_object(pk)</span><br><span class="line">        article.delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最大不同的是我们不需要在对用户的请求方法进行判断。该视图可以自动将不同请求转发到相应处理方法，逻辑上也更清晰，需要修改我们的url配置, 让其指向新的基于类的视图。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/$&#x27;</span>, views.ArticleList.as_view()),</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/(?P&lt;pk&gt;[0-9]+)$&#x27;</span>, views.ArticleDetail.as_view()),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns = format_suffix_patterns(urlpatterns)</span><br></pre></td></tr></table></figure>

<h4 id="（2）Mixin类和GenericAPI类混配-❌"><a href="#（2）Mixin类和GenericAPI类混配-❌" class="headerlink" title="（2）Mixin类和GenericAPI类混配(❌)"></a>（2）Mixin类和GenericAPI类混配(❌)</h4><p>使用基础的APIView类并没有大量简化我们的代码。如果你仔细地观察，你还会发现与增删改查操作相关的代码包括返回内容对所有模型几乎都是一样的。比如你现在需要对文章类别Category模型也进行序列化和反序列化，你只需要复制Article视图代码，将Article模型改成Category模型, 序列化类由ArticleSeralizer类改成CategorySerializer类就行了。</p>
<p>对于这些通用的增删改查行为，DRF已经提供了相应的Mixin类。Mixin类可与generics.GenericAPI类联用，灵活组合成你所需要的视图。</p>
<p>现在来使用Mixin类和generics.GenericAPI类重写我们的类视图。</p>
<p><em># blog/views.py</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用GENERIC APIView &amp; Mixins</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                  mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                  generics.GenericAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">list</span>(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>

<p>GenericAPIView 类继承了APIView类，提供了基础的API视图。它对用户请求进行了转发，并对Django自带的request对象进行了封装。不过它比APIView类更强大，因为它还可以通过queryset和serializer_class属性指定需要序列化与反序列化的模型或queryset及所用到的序列化器类。</p>
<p>这里的 ListModelMixin 和 CreateModelMixin类则分别引入了.list() 和 .create() 方法，当用户发送get请求时调用Mixin提供的list()方法，将指定queryset序列化后输出，发送post请求时调用Mixin提供的create()方法，创建新的实例对象。</p>
<p>DRF还提供RetrieveModelMixin, UpdateModelMixin和DestroyModelMixin类，实现了对单个对象实例的查、改和删操作，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetail</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                    mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                    mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                    generics.GenericAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>

<p>或许你现在要问已经有get, post, delete等方法了，为什么mixin类引入的方法要以list, create, retrieve, destroy方法命名呢? 这是因为请求方法不如操作名字清晰，比如get方法同时对应了获取对象列表和单个对象两种操作，使用list和retrieve方法后则很容易区分。另外post方法接受用户发过来的请求数据后，有时只需转发不需要创建模式对象实例，所以post方法不能简单等于create方法。</p>
<p>新的ArticleList视图类看似正确，但其实还有一个问题。 我们定义的序列化器ArticleSeralizer类并不包含author这个字段的，这是因为我们希望在创建article实例时我们将author与request.user进行手动绑定。在前面的例子中我们使用serializer.save(author=request.user)这一方法进行手动绑定。</p>
<p>现在使用mixin类后，我们该如何操作呢？ 答案是重写perform_create方法，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                  mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                  generics.GenericAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">list</span>(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将request.user与author绑定</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br></pre></td></tr></table></figure>

<p>.perform_create这个钩子函数是CreateModelMixin类自带的，用于执行创建对象时需要执行的其它方法，比如发送邮件等功能，有点类似于Django的信号。类似的钩子函数还有UpdateModelMixin提供的.perform_update方法和DestroyModelMixin提供的.perform_destroy方法。</p>
<h4 id="（3）通用视图generics-类"><a href="#（3）通用视图generics-类" class="headerlink" title="（3）通用视图generics.*类"></a>（3）通用视图generics.*类</h4><p>将Mixin类和GenericAPI类混配，已经帮助我们减少了一些代码，但我们还可以做得更好，比如将get请求与mixin提供的list方法进行绑定感觉有些多余。DRF还提供了一套常用的将 Mixin 类与 GenericAPI类已经组合好了的视图，进一步简化我们的代码，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># generic class-based views</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将request.user与author绑定</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetail</span>(<span class="params">generics.RetrieveUpdateDestroyAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class =ArticleSerializer</span><br></pre></td></tr></table></figure>

<p>generics.ListCreateAPIView类支持List、Create两种视图功能，分别对应GET和POST请求。generics.RetrieveUpdateDestroyAPIView支持Retrieve、Update、Destroy操作，其对应方法分别是GET、PUT和DELETE，其它常用generics.*类视图还包括ListAPIView, RetrieveAPIView, RetrieveUpdateAPIView等等。</p>
<h4 id="（4）视图集-viewset"><a href="#（4）视图集-viewset" class="headerlink" title="（4）视图集(viewset)"></a>（4）视图集(viewset)</h4><p>使用通用视图generics.*类后视图代码已经大大简化，但是ArticleList和ArticleDetail两个类中queryset和serializer_class属性依然存在代码重复。使用视图集可以将两个类视图进一步合并，一次性提供List、Create、Retrieve、Update、Destroy这5种常见操作，这样queryset和seralizer_class属性也只需定义一次, 如下：</p>
<p><em># blog/views.py</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="comment"># 用一个视图集替代ArticleList和ArticleDetail两个视图</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    <span class="comment"># 自行添加，将request.user与author绑定</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br></pre></td></tr></table></figure>

<p>使用视图集后，我们需要使用DRF提供的路由router来分发urls，因为一个视图集现在对应多个urls的组合，而不像之前的一个url对应一个视图函数或一个视图类。</p>
<p><em># blog/urls.py</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;articles&#x27;</span>, viewset=views.ArticleViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = []</span><br><span class="line"></span><br><span class="line">urlpatterns += router.urls</span><br></pre></td></tr></table></figure>

<p>一个视图集对应List、Create、Retrieve、Update、Destroy这5种操作。有时候我只需要其中的几种操作，该如何实现呢？答案是在urls.py中指定方法映射即可，如下所示：</p>
<p><em># blog/urls.py</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">article_list = views.ArticleViewSet.as_view(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;post&#x27;</span>: <span class="string">&#x27;create&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">article_detail = views.ArticleViewSet.as_view(&#123;</span><br><span class="line">    <span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;retrieve&#x27;</span>, <span class="comment"># 只处理get请求，获取单个记录</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/$&#x27;</span>, article_list),</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/(?P&lt;pk&gt;[0-9]+)$&#x27;</span>, article_detail),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns = format_suffix_patterns(urlpatterns)</span><br></pre></td></tr></table></figure>

<p>另外DRF还提供了ReadOnlyModelViewSet这个类，仅支持list和retrive这个操作。</p>
<h2 id="17-过滤-amp-排序"><a href="#17-过滤-amp-排序" class="headerlink" title="17.过滤 &amp; 排序"></a>17.过滤 &amp; 排序</h2><h3 id="（1）重写GenericsAPIView或viewset的get-queryset方法"><a href="#（1）重写GenericsAPIView或viewset的get-queryset方法" class="headerlink" title="（1）重写GenericsAPIView或viewset的get_queryset方法"></a>（1）重写GenericsAPIView或viewset的get_queryset方法</h3><p>此方法不依赖于任何第三方包, 只适合于需要过滤的字段比较少的模型。比如这里我们需要对文章title进行过滤，我们只需要修改ArticleList视图函数类即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"><span class="keyword">from</span> .permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .pagination <span class="keyword">import</span> MyPageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        keyword = self.request.query_params.get(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> keyword:</span><br><span class="line">            queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            queryset = Article.objects.<span class="built_in">filter</span>(title__icontains=keyword)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line">    <span class="comment"># associate user with article author.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br></pre></td></tr></table></figure>

<p>修改好视图类后，发送GET请求到/v1/articles?page=2&amp;q=django, 你将得到所有标题含有django关键词的文章列表，这里显示一共有3条结果。</p>
<p>当一个模型需要过滤的字段很多且不确定时(比如文章状态、正文等等), 重写get_queryset方法将变得非常麻烦，更好的方式是借助django-filter这个第三方库实现过滤。</p>
<h3 id="（2）使用django-filter"><a href="#（2）使用django-filter" class="headerlink" title="（2）使用django-filter"></a>（2）使用django-filter</h3><p><code>django-filter</code>库包含一个<code>DjangoFilterBackend</code>类，该类支持REST框架的高度可定制的字段过滤。这也是小编推荐的过滤方法, 因为它自定义需要过滤的字段非常方便, 还可以对每个字段指定过滤方法(比如模糊查询和精确查询)。具体使用方式如下：</p>
<p>1.安装django-filter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-filter</span><br></pre></td></tr></table></figure>

<p>2.将django_filters添加到INSTALLED_APPS</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ...,</span><br><span class="line">    django_filters,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>3.自定义FilterSet类。这里我们自定义了按标题关键词和文章状态进行过滤。</p>
<p><em># blog/filters.py(新建)</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> django_filters</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleFilter</span>(<span class="params">django_filters.FilterSet</span>):</span></span><br><span class="line">    q = django_filters.CharFilter(field_name=<span class="string">&#x27;title&#x27;</span>, lookup_expr=<span class="string">&#x27;icontains&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = (<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;status&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>如果你对django-filter中自定义FilterSet类比较陌生的话，可以先阅读下面两篇文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5OTMyODA4Nw==&mid=2247484288&idx=1&sn=14321a3373daa3a23575180452b9121e&chksm=a73c63b8904beaaeb2e4bebc3d172ef3a2ee24141a5279bcc83ea0f7030f879cc45d2b40422e&scene=21#wechat_redirect">Django-filter教程详解: 从安装使用到高阶美化分页-大江狗精品</a></li>
<li><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5OTMyODA4Nw==&mid=2247484686&idx=1&sn=8594fe93b71d1cce6a880c3d556aa097&chksm=a73c6536904bec209a95a05f28329c4bec8dac843945c402a63acc7131fc707840f7e8c00a4e&scene=21#wechat_redirect">Django 3.0实战: 仿链家二手房信息查询网(附GitHub源码)</a></li>
</ul>
<p>4.将自定义FilterSet类加入到View类或ViewSet，另外还需要将DjangoFilterBackend设为过滤后台，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># New for django-filter</span></span><br><span class="line"><span class="keyword">from</span> django_filters <span class="keyword">import</span> rest_framework</span><br><span class="line"><span class="keyword">from</span> .filters <span class="keyword">import</span> ArticleFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="comment"># new: filter backends and classes</span></span><br><span class="line">    filter_backends = (rest_framework.DjangoFilterBackend,)</span><br><span class="line">    filter_class = ArticleFilter</span><br><span class="line"></span><br><span class="line">    <span class="comment"># associate request.user with author.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br></pre></td></tr></table></figure>

<p>发送GET请求到/v1/articles?page=2&amp;q=django&amp;status=p, 你将得到如下返回结果，只包含发表了的文章。</p>
<p>你还可以看到REST框架提供了一个新的Filters下拉菜单按钮，可以帮助您对结果进行过滤(见上图标红部分)。</p>
<h3 id="（3）使用DRF提供的SearchFilter类"><a href="#（3）使用DRF提供的SearchFilter类" class="headerlink" title="（3）使用DRF提供的SearchFilter类"></a>（3）使用DRF提供的SearchFilter类</h3><p>其实DRF自带了具有过滤功能的SearchFilter类，其使用场景与Django-filter的单字段过滤略有不同，更侧重于使用一个关键词对模型的某个字段或多个字段同时进行搜索。</p>
<p>使用这个类，你还需要指定search_fields, 具体使用方式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> filters</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="comment"># new: add SearchFilter and search_fields</span></span><br><span class="line">    filter_backends = (filters.SearchFilter, )</span><br><span class="line">    search_fields = (<span class="string">&#x27;title&#x27;</span>,)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># associate request.user with author.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发送GET请求到/v1/articles?page=1&amp;search=django, 你将得到如下结果。<strong>注意</strong>：这里进行搜索查询的默认参数名为?search=xxx。</p>
<p>SearchFilter类非常有用，因为它不仅支持对模型的多个字段进行查询，还支持ForeinKey和ManyToMany字段的关联查询。按如下修改search_fields, 就可以同时搜索标题或用户名含有某个关键词的文章资源列表。修改好后，作者用户名里如果有django，该篇文章也会包含在搜索结果了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search_fields = (<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;author__username&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>默认情况下，SearchFilter类搜索将使用不区分大小写的部分匹配(icontains)。你可以在search_fields中添加各种字符来指定匹配方法。</p>
<ul>
<li>‘^’开始 - 搜索。</li>
<li>‘=’完全匹配。</li>
<li>‘@’全文搜索。</li>
<li>‘$’正则表达式搜索。</li>
</ul>
<p>例如：search_fields = (‘=title’, )精确匹配title。</p>
<p>前面我们详细介绍了对结果进行过滤的3种方法，接下来我们再看看如何对结果进行排序，这里主要通过DRF自带的OrderingFilter类实现。</p>
<p><strong>使用DRF的OrderingFilter类</strong></p>
<p>使用OrderingFilter类首先要把它加入到filter_backends, 然后指定排序字段即可，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> filters</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    filter_backends = (filters.SearchFilter, filters.OrderingFilter,)</span><br><span class="line">    search_fields = (<span class="string">&#x27;title&#x27;</span>,)</span><br><span class="line">    ordering_fields = (<span class="string">&#x27;create_date&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>发送请求时只需要在参数上加上?ordering=create_date或者?ordering=-create_date即可实现对结果按文章创建时间正序和逆序进行排序。</p>
<p>点击DRF界面上的Filters按钮，你还会看到搜索和排序的选项。 </p>
<h2 id="18-限流"><a href="#18-限流" class="headerlink" title="18.限流"></a>18.限流</h2><h3 id="（1）限流-Throttle-概述"><a href="#（1）限流-Throttle-概述" class="headerlink" title="（1）限流(Throttle)概述"></a>（1）限流(Throttle)概述</h3><p>限流(Throttle)就是限制客户端对API 的调用频率，是API开发者必须要考虑的因素。比如个别客户端(比如爬虫程序)短时间发起大量请求，超过了服务器能够处理的能力，将会影响其它用户的正常使用。又或者某个接口占用数据库资源比较多，如果同一时间该接口被大量调用，服务器可能会陷入僵死状态。为了保证API服务的稳定性，并防止接口受到恶意用户的攻击，我们必须要对我们的API服务进行限流。</p>
<p>DRF中限制对API的调用频率非常简便，它为我们主要提供了3个可插拔使用的限流类，分别是AnonRateThrottle, UserRateThrottle和ScopeRateThrottle类。</p>
<ul>
<li>AnonRateThrottle 用于限制未认证用户的请求频率，主要根据用户的 IP地址来确定用户身份。</li>
<li>UserRateThrottle 用于限定认证用户的请求频率，可对不同类型的用户实施不同的限流政策。</li>
<li>ScopeRateThrottle可用于限制对 API 特定部分的访问。只有当正在访问的视图包含 <em>throttle_scope</em> 属性时才会应用此限制。这个与UserRateThrottle类的区别在于一个针对用户限流，一个针对API接口限流。</li>
</ul>
<p>DRF限制频率的指定格式为 “最大访问次数/时间间隔”，例如设置为 5/min，则只允许一分钟内最多调用接口 5 次。其它常用格式包括”10/s”, “100/d”等。超过限定次数的调用将抛出 exceptions.Throttled 异常，客户端收到 429 状态码（too many requests）的响应。</p>
<p><strong>全局使用限流类</strong></p>
<p>在前面的案例中，当你访问/v1/articles/，你将得到如下所示文章资源列表。这个接口是没有限流的，所以在短时间内你无论刷新多少次浏览器，也不会得到报错。现在我们要对这个接口增加限流，匿名用户请求频率限制在”2/min”，即一分钟两次，而认证用户请求频率限制在”10/min”, 即一分钟10次。</p>
<p>最简单的使用DRF自带限流类的方法，就是在settings.py中进行全局配置，如下所示。一是要设置需要使用的限流类，二是要设置限流范围(scope)及其限流频率。AnonRateThrottle和UserRateThrottle默认的scope分别为”anon”和”user”。该配置会对所有API接口生效。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;2/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;10/min&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在短时间内快速刷新你的浏览器或通过postman发送多个请求到/v1/articles，如果你是匿名用户，当你的每分钟请求数量累计达到2次时，你将看到如下返回信息。如果你是认证用户，你的每分钟请求数量达到10次时才会被限流。当你访问其它接口，会受到同样限流限制。</p>
<h3 id="（2）视图类或视图集中使用限流类"><a href="#（2）视图类或视图集中使用限流类" class="headerlink" title="（2）视图类或视图集中使用限流类"></a>（2）视图类或视图集中使用限流类</h3><p>DRF中还可以在单个视图或单个视图集中进行限流配置，单个视图中的配置会覆盖全局设置。现在我们希望保留settings.py的限流全局配置，并专门为文章资源列表/v1/articles定制一个限流类，新的访问频率限制为匿名用户为”5/min”, 认证用户为”30/min”，该配置仅对文章资源列表这个接口生效。</p>
<p>我们首先在app文件夹blog目录下新建throttles.py, 添加如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> AnonRateThrottle, UserRateThrottle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleListAnonRateThrottle</span>(<span class="params">AnonRateThrottle</span>):</span></span><br><span class="line">    THROTTLE_RATES = &#123;<span class="string">&quot;anon&quot;</span>: <span class="string">&quot;5/min&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleListUserRateThrottle</span>(<span class="params">UserRateThrottle</span>):</span></span><br><span class="line">    THROTTLE_RATES = &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;30/min&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>我们通过继承自定义了ArticleListAnonRateThrottle, ArticleListUserRateThrottle两个类，并通过THROTTLE_RATES属性设置了新的访问频率限制。现在我们可以将它们应用到views.py中对应文章资源列表的API视图类。无需重启测试服务器，你将发现新的限流设置已经生效了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .throttles <span class="keyword">import</span> ArticleListAnonRateThrottle, ArticleListUserRateThrottle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line">    throttle_classes = [ArticleListAnonRateThrottle, ArticleListUserRateThrottle]</span><br></pre></td></tr></table></figure>

<p>有时对一个认证用户进行限流不仅要限制每分钟的请求次数，还需要限制每小时的请求次数，这时该如何操作呢? 我们可以自定义两个UserRateThrottle子类，并设置不同的scope，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> AnonRateThrottle, UserRateThrottle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinuteUserRateThrottle</span>(<span class="params">UserRateThrottle</span>):</span></span><br><span class="line">    scope = <span class="string">&#x27;limit_per_minute&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HourUserRateThrottle</span>(<span class="params">UserRateThrottle</span>):</span></span><br><span class="line">    scope = <span class="string">&#x27;limit_per_hour&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然后修改我们的视图类，使用新的限流类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">throttle_classes = [HourUserRateThrottle, MinuteUserRateThrottle]</span><br></pre></td></tr></table></figure>

<p> 现在我们只指定了限流类，还未设置限流频率，那么到哪里去设置呢? 你可以去settings.py中设置，也可以在自定义限流类中通过THROTTLE_RATES属性指定。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;2/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;10/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;limit_per_minute&#x27;</span>:<span class="string">&#x27;5/min&#x27;</span>, <span class="comment"># 新增</span></span><br><span class="line">        <span class="string">&#x27;limit_per_hour&#x27;</span>: <span class="string">&#x27;500/hour&#x27;</span>, <span class="comment"># 新增</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（3）如何使用ScopeRateThrottle类"><a href="#（3）如何使用ScopeRateThrottle类" class="headerlink" title="（3）如何使用ScopeRateThrottle类"></a>（3）如何使用ScopeRateThrottle类</h3><p>AnonRateThrottle和UserRateThrottle类都是针对单个用户请求进行限流的，而ScopeRateThrottle类是针对不同API接口资源进行限流的，限制的是所有用户对接口的访问总数之和。使用时直接在视图类里通过<em>throttle_scope</em> 属性指定限流范围(scope), 然后在settings.py对不同scope设置限流频率。例子如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleListView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    throttle_scope = <span class="string">&#x27;article_list&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetailView</span>(<span class="params">APIView</span>):</span>    </span><br><span class="line">    throttle_scope = <span class="string">&#x27;article_detail&#x27;</span></span><br></pre></td></tr></table></figure>

<p>针对不同api接口设置不同限流频率。如下配置代表文章资源列表一天限1000次请求(所有用户访问数量之和)，文章详情接口限1小时100次。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.ScopedRateThrottle&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;2/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;10/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;article_list&#x27;</span>:<span class="string">&#x27;1000/day&#x27;</span>, <span class="comment"># 新增</span></span><br><span class="line">        <span class="string">&#x27;article_detail&#x27;</span>: <span class="string">&#x27;100/hour&#x27;</span>, <span class="comment"># 新增</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（4）如何自定义复杂的限流类"><a href="#（4）如何自定义复杂的限流类" class="headerlink" title="（4）如何自定义复杂的限流类"></a>（4）如何自定义复杂的限流类</h3><p>有时你还需要自定义限流类。这时你需要继承BaseThrottle类、SimpleRateThrottle或者UserRateThrottle类，然后重写*allow_request(self, request, view)<em>或者</em>get_rate(self, request=none)*方法。DRF给的示例方法如下所示，该限流类10个请求中只允许一个通过。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomRateThrottle</span>(<span class="params">throttling.BaseThrottle</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">return</span> random.randint(<span class="number">1</span>, <span class="number">10</span>) != <span class="number">1</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="常见-HTTP-请求行为"><a href="#常见-HTTP-请求行为" class="headerlink" title="常见 HTTP 请求行为"></a>常见 HTTP 请求行为</h2><ul>
<li>GET（SELECT）：从服务器取出资源（一项或多项）。</li>
<li>POST（CREATE）：在服务器新建一个资源。</li>
<li>PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。</li>
<li>DELETE（DELETE）：从服务器删除资源。</li>
<li>PATCH（UPDATE）：在服务器更新(更新)资源（客户端提供改变的属性）。</li>
<li>HEAD：获取资源的元数据。</li>
<li>OPTIONS：获取信息，关于资源的哪些属性是客户端可以改变的。</li>
</ul>
<h2 id="HTTP-状态码"><a href="#HTTP-状态码" class="headerlink" title="HTTP 状态码"></a>HTTP 状态码</h2><p>服务器向用户返回的状态码和提示信息：</p>
<ul>
<li>200 OK - [GET]：服务器成功返回用户请求的数据</li>
<li>201 CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功</li>
<li>202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</li>
<li>204 NO CONTENT - [DELETE]：用户删除数据成功</li>
<li>400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据操作</li>
<li>401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</li>
<li>403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</li>
<li>404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</li>
<li>406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</li>
<li>410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</li>
<li>422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</li>
<li>500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</li>
</ul>
<h2 id="基础实践"><a href="#基础实践" class="headerlink" title="基础实践"></a>基础实践</h2><p>Install</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install django</span><br><span class="line">pip install djangorestframework</span><br></pre></td></tr></table></figure>

<p>创建项目</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject &quot;project_name&quot;</span><br></pre></td></tr></table></figure>

<p>创建应用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp &quot;app_name&quot;</span><br></pre></td></tr></table></figure>

<p>创建数据库文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br></pre></td></tr></table></figure>

<p>数据库迁移</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>

<p>启动项目</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver</span><br></pre></td></tr></table></figure>

<p>新建模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    评论</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    email = models.EmailField()</span><br><span class="line">    content = models.TextField()</span><br><span class="line">    created = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    objects = models.Manager()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;<span class="subst">&#123;self.content&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<p>更新配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [    </span><br><span class="line">  	...</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;comment&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>更新URL</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;comment/&#x27;</span>, include(<span class="string">&#x27;comment.urls&#x27;</span>)),</span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>新增应用API: <code>apis.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> CommentSerializer</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Comment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span>(<span class="params">generics.ListCreateAPIView</span>):</span></span><br><span class="line">    serializer_class = CommentSerializer</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Comment.objects.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>新增应用URL: <code>urls.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> .apis <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, <span class="type">List</span>.as_view(), name=<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>创建管理员身份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createsuperuser</span><br></pre></td></tr></table></figure>

<h2 id="Centos配置Django"><a href="#Centos配置Django" class="headerlink" title="Centos配置Django"></a>Centos配置Django</h2><p>更新系统软件包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></table></figure>

<p>安装软件管理包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y groupinstall &quot;Development tools&quot;</span><br><span class="line"></span><br><span class="line">yum install openssl-devel bzip2-devel expat-devel gdbm-devel readline-devel sqlite-devel psmisc libffi-devel</span><br></pre></td></tr></table></figure>

<p>下载python3 到 /usr/local目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local</span><br><span class="line">wget https:&#x2F;&#x2F;www.python.org&#x2F;ftp&#x2F;python&#x2F;3.6.6&#x2F;Python-3.6.6.tgz</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;解压</span><br><span class="line">tar -zxvf Python-3.6.6.tgz</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;进入</span><br><span class="line">cd Python-3.6.6</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 编译</span><br><span class="line">.&#x2F;config --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;python3</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 安装</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;建立软链接，在终端也可以直接使用python3</span><br><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;python3&#x2F;bin&#x2F;python3.6 &#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;为pip建立软链接</span><br><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;python3&#x2F;bin&#x2F;pip3.6 &#x2F;usr&#x2F;bin&#x2F;pip3</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;查看是否安装成功</span><br><span class="line">python3 -V</span><br><span class="line">pip3 -V</span><br></pre></td></tr></table></figure>

<p>安装virtualenv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 install virtualenv</span><br><span class="line"></span><br><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;python3&#x2F;bin&#x2F;virtualenv &#x2F;usr&#x2F;bin&#x2F;virtualenv</span><br></pre></td></tr></table></figure>

<p>新建虚拟环境目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p data&#x2F;env</span><br><span class="line"></span><br><span class="line">cd data&#x2F;env</span><br><span class="line"></span><br><span class="line">virtualenv --python&#x3D;&#x2F;usr&#x2F;bin&#x2F;python3 djangoenv &#x2F;&#x2F; djangoenv是自定义名称</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 启动虚拟环境</span><br><span class="line">source activate</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;虚拟环境中安装django uwsgi</span><br><span class="line">pip3 install django</span><br><span class="line">pip3 install uwsgi</span><br><span class="line"></span><br><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;python3&#x2F;bin&#x2F;uwsgi &#x2F;usr&#x2F;bin&#x2F;uwsgi</span><br></pre></td></tr></table></figure>

<p>将项目目录下环境依赖导出到requirements.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip freeze &gt; requirements.txt</span><br></pre></td></tr></table></figure>

<p>项目上传 基于fileziila并解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y unzip zip</span><br><span class="line"></span><br><span class="line">unzip file.zip</span><br></pre></td></tr></table></figure>

<p>导入数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>

<p>创建与项目中相应名称的数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create database guojunmingblog</span><br><span class="line"></span><br><span class="line">use guojuningblog</span><br><span class="line"></span><br><span class="line">source &#x2F;SQL文件目录地址</span><br></pre></td></tr></table></figure>

<p>run</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py runserver</span><br></pre></td></tr></table></figure>

<p>配置uwsgi文件，例如项目名 guojunmingblog，则在项目根目录下创建 guojunmingblog.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;uwsgi&gt;</span><br><span class="line">  &lt;socket&gt;127.0.0.1:8000&lt;&#x2F;socket&gt; &lt;!-- 内部端口，自定义 --&gt; 		  </span><br><span class="line">  &lt;chdir&gt;&#x2F;root&#x2F;blog&#x2F;kuls_blog&lt;&#x2F;chdir&gt; &lt;!-- 项目路径 --&gt; </span><br><span class="line">  &lt;module&gt;kuls_blog.wsgi&lt;&#x2F;module&gt; &lt;!-- mysite为wsgi.py所在目录名--&gt; </span><br><span class="line">  &lt;processes&gt;4&lt;&#x2F;processes&gt; &lt;!-- 进程数 --&gt; </span><br><span class="line">  &lt;daemonize&gt;uwsgi.log&lt;&#x2F;daemonize&gt; &lt;!-- 日志文件 --&gt;</span><br><span class="line">&lt;&#x2F;uwsgi&gt;</span><br></pre></td></tr></table></figure>

<p>安装nginx和配置nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;</span><br><span class="line">wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.13.7.tar.gz</span><br><span class="line">&#x2F;&#x2F; 执行解压命令</span><br><span class="line">tar -zxvf nginx-1.13.7.tar.gz</span><br><span class="line">&#x2F;&#x2F; 解压后进入文件夹</span><br><span class="line">.&#x2F;configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">&#x2F;&#x2F; 备份conf文件</span><br><span class="line">cp nginx.conf nginx.conf.bak</span><br></pre></td></tr></table></figure>

<p>编辑conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name 127.0.0.1:80; #改为自己的域名，没域名修改为127.0.0.1:80 charset utf-8;</span><br><span class="line">location &#x2F; &#123;</span><br><span class="line">include uwsgi_params;</span><br><span class="line">uwsgi_pass 127.0.0.1:8000; #端口要和uwsgi里配置的一样</span><br><span class="line">uwsgi_param UWSGI_SCRIPT kuls_blog.wsgi; #wsgi.py所在的目录名+.wsgi uwsgi_param UWSGI_CHDIR &#x2F;root&#x2F;blog&#x2F;kuls_blog; #项目路径</span><br><span class="line">&#125;</span><br><span class="line">location &#x2F;static&#x2F; &#123;</span><br><span class="line">alias &#x2F;root&#x2F;blog&#x2F;kuls_blog&#x2F;static&#x2F;; #静态资源路径 &#125;</span><br><span class="line"> &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>进入/usr/local/nginx/sbin目录执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;nginx</span><br></pre></td></tr></table></figure>

<p>查看Uwsgi进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep uwsgi</span><br></pre></td></tr></table></figure>

<p>用kill方法把uwsgi进程杀死，再启动uwsgi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">killall -9 uwsgi</span><br></pre></td></tr></table></figure>

<p>启动方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uwsgi -x mysite.xml</span><br></pre></td></tr></table></figure>

<p>nginx平滑重启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload</span><br></pre></td></tr></table></figure>

<p>项目中应用含有静态文件，需要在setting.py进行STATIC_ROOT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ROOT &#x3D; os.path.join(BASE_DIR, &#39;static&#39;) # 指定样式收集目录</span><br></pre></td></tr></table></figure>

<p>执行下面指令，自动把静态文件收集到/static/目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py collectstatic</span><br></pre></td></tr></table></figure>

<p>mysql开机启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;设置开机启动</span><br><span class="line">systemctl enable mysqld.service</span><br><span class="line">&#x2F;&#x2F;检查是否设置成功</span><br><span class="line">systemctl list-unit-files | grep mysqld</span><br><span class="line">&#x2F;&#x2F;开启MYSQL服务</span><br><span class="line">systemctl start mysqld.service</span><br></pre></td></tr></table></figure>

<p>修改密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;查看密码</span><br><span class="line">grep &#39;temporary password&#39; &#x2F;var&#x2F;log&#x2F;mysqld.log</span><br><span class="line">&#x2F;&#x2F;登录</span><br><span class="line">mysql -u root -p</span><br><span class="line">&#x2F;&#x2F;修改</span><br><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;MyNewPassword&#39;;</span><br><span class="line">&#x2F;&#x2F;命令生效</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>

<p>mysql端口被占用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;查看3306端口是否被占用</span><br><span class="line">netstat -nlt|grep mysql</span><br><span class="line">&#x2F;&#x2F; kill -9 pid</span><br></pre></td></tr></table></figure>

<p>外网访问问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#远程设置</span><br><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; update user set host&#x3D;&#39;%&#39; where user&#x3D;&#39;root&#39;; </span><br><span class="line">#授权用户名的权限，赋予任何主机访问数据的权限</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39; WITH GRANT OPTION; mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line"># 设置密码</span><br><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;Root!2018&#39; PASSWORD EXPIRE NEVER;</span><br><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;%&#39; IDENTIFIED WITH mysql_native_password BY &#39;Root!2018&#39;;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p>关闭防火墙</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 关闭防火墙</span><br><span class="line">sudo systemctl stop firewalld.service</span><br><span class="line"># 关闭开机启动</span><br><span class="line">sudo systemctl disable firewalld.service</span><br></pre></td></tr></table></figure>

<h2 id="Markdown-编辑器"><a href="#Markdown-编辑器" class="headerlink" title="Markdown 编辑器"></a>Markdown 编辑器</h2><p><strong>Github</strong>地址**:** <a target="_blank" rel="noopener" href="https://github.com/pylixm/django-mdeditor">https://github.com/pylixm/django-mdeditor</a></p>
<p>Django-mdeditor是基于editor.md的一个django Markdown 文本编辑插件应用。</p>
<p>Django-mdeditor的灵感参考自项目 django-ckeditor <a target="_blank" rel="noopener" href="https://github.com/django-ckeditor/django-ckeditor">https://github.com/django-ckeditor/django-ckeditor</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install django-mdeditor # 用于后台编辑</span><br><span class="line">pip install markdown  # 用于前端显示</span><br></pre></td></tr></table></figure>

<p>settings配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS &#x3D; [&#39;meditor&#39;]</span><br><span class="line"></span><br><span class="line">MEDIA_ROOT &#x3D; os.path.join(BASE_DIR, &#39;media&#39;)</span><br><span class="line"></span><br><span class="line">MEDIA_URL &#x3D; &#39;&#x2F;media&#x2F;&#39;  # 上传的文件和图片都会默认保存在&#x2F;media&#x2F;editor下</span><br></pre></td></tr></table></figure>

<p>url配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from django.conf import settings</span><br><span class="line">from django.conf.urls.static import static</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [path(&#39;mdeditor&#x2F;&#39;, include(&#39;mdeditor&#39;))]</span><br><span class="line"></span><br><span class="line">if settings.DEBUG:</span><br><span class="line">	urlpatterns +&#x3D; static(settings.MEDIA_URL, document_root&#x3D;settings.MEDIA_ROOT)</span><br></pre></td></tr></table></figure>

<p>model配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Article(model.Model):</span><br><span class="line">	...</span><br><span class="line">	body &#x3D; MDTextField()</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<p>admin配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin.site.register(Article)</span><br></pre></td></tr></table></figure>

<p>接口配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># markdown.extensions.extra: 用于标题、表格、引用这些 基本转换</span></span><br><span class="line"><span class="comment"># markdown.extensions.codehilite: 用于语法高亮</span></span><br><span class="line"><span class="comment"># markdown.extensions.toc: 用于生成目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># eg.</span></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Post</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post_article</span>(<span class="params">request, pk</span>):</span></span><br><span class="line">	post = get_object_or_404(Post, pk)</span><br><span class="line">  post.body markdown.markdown(post.body,</span><br><span class="line">                                extensions=[</span><br><span class="line">                                   <span class="string">&#x27;markdown.extensions.extra&#x27;</span></span><br><span class="line">                                   <span class="string">&#x27;markdown.extensions.codehilite&#x27;</span></span><br><span class="line">                                   <span class="string">&#x27;markdown.extensions.toc&#x27;</span>,</span><br><span class="line">                                   ])</span><br><span class="line">	<span class="keyword">return</span> render(request, <span class="string">&#x27;blog/detail.html&#x27;</span>,context=&#123;<span class="string">&#x27;post&#x27;</span>: post&#125;)</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><hr>
<h2 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h2><ol>
<li>POST URL重定向</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Q: RuntimeError: You called this URL via POST, but the URL doesn&#39;t end in a slash and you have APPEND_SLASH set. Django can&#39;t redirect to the slash URL while maintaining POST data. Change your form to point to 127.0.0.1:8000&#x2F;project&#x2F;636&#x2F;orchestrations&#x2F;5&#x2F;versions&#x2F; (note the trailing slash), or set APPEND_SLASH&#x3D;False in your Django settings.</span><br><span class="line">2021-03-10 19:04:52,486 - ERROR - &quot;POST &#x2F;project&#x2F;636&#x2F;orchestrations&#x2F;5&#x2F;versions HTTP&#x2F;1.1&quot; 500 68836</span><br><span class="line">A: 1.确保form表单的action或URL是否以&#x2F;结尾，例如127.0.0.1:8000&#x2F;version&#x2F;</span><br><span class="line">   2.修改settings.py，添加以下内容 APPEND_SLASH&#x3D;False</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>TemplateDoesNotExist</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Q: Django: TemplateDoesNotExist (rest_framework&#x2F;api.html)</span><br><span class="line">A: Make sure you have rest_framework in your settings&#39;s INSTALLED_APPS</span><br></pre></td></tr></table></figure>






      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/10/Django/" data-id="cknbeav2g0019nltd7xndhin8" data-title="Django &amp; DRF" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2021/04/07/EKL/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">EKL</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Django/">Django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Django-DRF/">Django & DRF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Notes/">Notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Practice/">Practice</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Private/">Private</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sql/">sql</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/10/Django/">Django &amp; DRF</a>
          </li>
        
          <li>
            <a href="/2021/04/07/EKL/">EKL</a>
          </li>
        
          <li>
            <a href="/2021/04/06/Sentry/">Sentry</a>
          </li>
        
          <li>
            <a href="/2021/04/01/k8s/">k8s</a>
          </li>
        
          <li>
            <a href="/2021/04/01/Python/">Python</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 Jimmy Guo<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>